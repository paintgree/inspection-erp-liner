{% extends "base.html" %}
{% block content %}
<a class="btn btn-ghost" href="/dashboard">← Back</a>

<div class="card">
  <div class="runheader">
    <div>
      <h1>{{ run.process }} — Batch: {{ run.dhtp_batch_no }}</h1>
      <div class="muted">Status: <b>{{ run.status }}</b></div>
      <div class="muted">Progress: <b>{{ progress }}%</b></div>
    </div>

    <div class="actions">
      {% if user.role == "MANAGER" %}
        <a class="btn" href="/runs/{{ run.id }}/edit">Edit Run + Parameters</a>

        {% if run.status == "OPEN" %}
          <form method="post" action="/runs/{{ run.id }}/close"
                onsubmit="return confirm('Are you sure you want to CLOSE this run? Inspectors cannot add entries until you Reopen.');">
            <button class="btn" type="submit">Close</button>
          </form>
        {% endif %}

        {% if run.status == "CLOSED" %}
          <form method="post" action="/runs/{{ run.id }}/approve"
                onsubmit="return confirm('Approve this run? It will be locked. You can Reopen later if needed.');">
            <button class="btn" type="submit">Approve</button>
          </form>
        {% endif %}

        {% if run.status in ["CLOSED","APPROVED"] %}
          <form method="post" action="/runs/{{ run.id }}/reopen"
                onsubmit="return confirm('Reopen this run? Inspectors can add entries again.');">
            <button class="btn" type="submit">Reopen</button>
          </form>
        {% endif %}
      {% endif %}

      {% if not (run.status in ["CLOSED","APPROVED"] and user.role != "MANAGER") %}
        <a class="btn btn-primary" href="/runs/{{ run.id }}/entry/new">+ New Inspection Entry</a>
      {% else %}
        <span class="muted"><b>Locked:</b> Manager must reopen.</span>
      {% endif %}

      <a class="btn" href="/runs/{{ run.id }}/export/xlsx">Export XLSX</a>
    </div>
  </div>

  {% if image_url %}
    <div class="imgwrap">
      <img class="pipeimg" src="{{ image_url }}" alt="process image">
    </div>
  {% endif %}

  <div class="card inner mt">
    <h2>In-Process Inspection — Day {{ selected_day }}</h2>

    <div class="tablewrap">
      <table class="table wide">
        <thead>
          <tr>
            <th>Parameter</th>
            {% for s in ["00:00","02:00","04:00","06:00","08:00","10:00","12:00","14:00","16:00","18:00","20:00","22:00"] %}
              <th>{{ s }}</th>
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {% for p in params %}
          <tr>
