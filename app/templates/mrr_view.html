{% extends "base.html" %}
{% block content %}

<a class="btn btn-ghost" href="/mrr">← Back</a>

<div class="card">

  <div class="runheader">
    <div>
      <h1>MRR Ticket #{{ lot.id }}</h1>
      <div class="muted">
        Type: <b>{{ lot.lot_type }}</b> •
        Batch: <b>{{ lot.batch_no or "-" }}</b> •
        Status: <b>{{ lot.status or "-" }}</b>
      </div>
    </div>

    <div class="actions">
      <a class="btn" href="/mrr/{{ lot.id }}/export/xlsx">Export XLSX</a>
      <a class="btn" href="/mrr/{{ lot.id }}/export/pdf">Export PDF</a>

      {% if user.role and user.role|upper == "MANAGER" %}
        <a class="btn btn-warn" href="/mrr-pending-approvals">Pending approvals</a>
      {% endif %}

      {% if user.role and user.role|upper == "MANAGER"
            and not readonly
            and (lot.status or "")|upper != "CANCELED" %}
        <form method="post" action="/mrr/{{ lot.id }}/cancel" style="display:inline;"
              onsubmit="return confirm('Cancel this ticket? It will be hidden from normal list and actions will be blocked.')">
          <button class="btn btn-warn" type="submit">Cancel Ticket</button>
        </form>
      {% endif %}

      {% if user.role and user.role|upper == "MANAGER"
            and inspection_to_approve
            and inspection_to_approve.inspector_confirmed
            and not inspection_to_approve.manager_approved %}
        <form method="post"
              action="/mrr/{{ lot.id }}/inspection/id/{{ inspection_to_approve.id }}/approve"
              style="display:inline;"
              onsubmit="return confirm('Approve this receiving inspection?')">
          <button class="btn btn-primary" type="submit">Approve Receiving Inspection</button>
        </form>
      {% endif %}

      {% if user.role and user.role|upper == "MANAGER"
            and latest_approved_inspection
            and latest_approved_inspection.manager_approved %}
        <form method="post"
              action="/mrr/{{ lot.id }}/inspection/id/{{ latest_approved_inspection.id }}/unapprove"
              style="display:inline;"
              onsubmit="return confirm('Unapprove will reopen the ticket for adjustments. Continue?')">
          <button class="btn btn-warn" type="submit">Unapprove Last Approval</button>
        </form>
      {% endif %}
    </div>
  </div>

  {% set docs_ok = (receiving and (receiving.inspector_confirmed_po or receiving.manager_confirmed_po)) %}
  {% set insp_submitted = (inspection and inspection.inspector_confirmed) %}
  {% set insp_ok = (inspection and inspection.manager_approved) %}

  {% if error %}
    <div class="alert alert-error mt">{{ error }}</div>
  {% endif %}

  {% if readonly %}
    <div class="alert alert-warn mt">
      This MRR Ticket is <b>CANCELED</b>. You are viewing it in <b>read-only</b> mode.
    </div>
  {% endif %}

  <!-- BASIC INFO -->
  <div class="card inner mt">
    <h2>Basic Info</h2>

    <div class="kv"><span>Material</span><b>{{ lot.material_name or "-" }}</b></div>
    <div class="kv"><span>Supplier</span><b>{{ lot.supplier_name or "-" }}</b></div>
    <div class="kv"><span>PO</span><b>{{ lot.po_number or "-" }}</b></div>

    <div class="kv">
      <span>Used Delivery Note(s)</span>
      <b>
        {% if used_dns and used_dns|length > 0 %}
          {{ used_dns | join(", ") }}
        {% else %}
          -
        {% endif %}
      </b>
    </div>

    <div class="kv">
      <span>Quantity (PO)</span>
      <b>{{ lot.quantity if lot.quantity is not none else "-" }} {{ lot.quantity_unit if lot.quantity_unit else "" }}</b>
    </div>

    <div class="kv">
      <span>Received Total</span>
      <b>
        {{ lot.received_total if lot.received_total is not none else 0 }}
        {% if lot.quantity_unit and lot.quantity_unit|upper in ["PC","PCS"] %}
          {{ lot.quantity_unit }}
        {% else %}
          KG (normalized)
        {% endif %}
      </b>
    </div>
  </div>

  <!-- SHIPMENT REPORTS SUMMARY -->
  <div class="card inner mt">
    <h2>Shipment Inspection Reports</h2>
    <div class="muted tiny">Submitted shipment reports are visible to anyone reviewing this ticket.</div>

    {% if submitted_shipments and submitted_shipments|length > 0 %}
      <div class="tablewrap mt">
        <table class="table wide">
          <thead>
            <tr>
              <th>Shipment</th>
              <th>DN</th>
              <th>Arrived</th>
              <th>Batch No(s)</th>
              <th>Report</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for s in submitted_shipments %}
              {% set batches = batch_numbers_map.get(s.id, []) %}
              <tr>
                <td>#{{ loop.index }}</td>
                <td>{{ s.delivery_note_no or "-" }}</td>
                <td>{{ s.qty_arrived }} {{ s.qty_unit }}</td>
                <td>
                  {% if batches %}
                    {% for b in batches %}
                      <div>{{ b }}</div>
                    {% endfor %}
                  {% else %}
                    <span class="muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <a class="btn btn-sm" href="/mrr/{{ lot.id }}/inspection/id/{{ s.id }}">Open</a>
                </td>
                <td>
                  {% if s.manager_approved %}
                    <span class="badge badge-ok">APPROVED</span>
                  {% else %}
                    <span class="badge badge-warn">SUBMITTED</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="muted mt">No submitted shipment inspections yet.</div>
    {% endif %}
  </div>

  <!-- PROGRESS + ACTIONS -->
  <div class="card inner mt">
    <h2>Progress</h2>
    <div class="kv"><span>Documentation</span><b>{% if docs_ok %}CLEARED{% elif receiving %}SAVED{% else %}PENDING{% endif %}</b></div>
    <div class="kv"><span>Receiving Inspection</span><b>{% if insp_ok %}APPROVED{% elif insp_submitted %}SUBMITTED{% else %}PENDING{% endif %}</b></div>

    {% if not readonly %}
      <div class="toolbar mt">
        {% if (lot.status or "")|upper != "APPROVED" %}
          <a class="btn btn-primary" href="/mrr/{{ lot.id }}/inspection/new">
            {% if lot.status and lot.status|upper == "PARTIAL" %}
              Start Shipment Inspection (Partial Delivery)
            {% else %}
              Start Shipment Inspection
            {% endif %}
          </a>
        {% else %}
          <div class="muted mt">✅ Ticket is <b>APPROVED</b> — receiving is closed (no further inspections allowed).</div>
        {% endif %}
      </div>
    {% else %}
      <div class="muted mt">Actions disabled (ticket canceled).</div>
    {% endif %}
  </div>

</div>

{% endblock %}
