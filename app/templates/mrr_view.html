{% extends "base.html" %}
{% block content %}

<a class="btn btn-ghost" href="/mrr">← Back</a>

<div class="card">

  <!-- =========================
       HEADER
  ========================== -->
  <div class="runheader">
    <div>
      <h1>MRR Ticket #{{ lot.id }}</h1>
      <div class="muted">
        Type: <b>{{ lot.lot_type }}</b> •
        Batch: <b>{{ lot.batch_no }}</b> •
        Status: <b>{{ lot.status }}</b>
      </div>
    </div>

    <div class="actions">
      <a class="btn" href="/mrr/{{ lot.id }}/export/xlsx">Export XLSX</a>
      <a class="btn" href="/mrr/{{ lot.id }}/export/pdf">Export PDF</a>

      {% if user.role and user.role|upper == "MANAGER" %}
        <a class="btn" href="/mrr/{{ lot.id }}/pending">Pending approvals</a>
      {% endif %}

      {% if not readonly and user.role and user.role|upper == "MANAGER" %}
        <form method="post" action="/mrr/{{ lot.id }}/cancel" style="display:inline;">
          <button class="btn btn-danger" type="submit">Cancel Ticket</button>
        </form>
      {% endif %}
    </div>
  </div>

  {% if error %}
    <div class="alert alert-error mt">{{ error }}</div>
  {% endif %}

  <!-- =========================
       WHAT'S PENDING
  ========================== -->
  <div class="card inner mt">
    <h2>What’s pending?</h2>
    <ul class="checklist">
      <li>{% if docs and docs|length > 0 %}✅{% else %}❌{% endif %} Documents uploaded</li>
      <li>{% if receiving %}✅{% else %}❌{% endif %} Documentation saved</li>
      <li>{% if docs_ok %}✅{% else %}❌{% endif %} Documentation cleared (ready for inspection)</li>
      <li>{% if insp_submitted %}✅{% else %}❌{% endif %} Receiving Inspection submitted</li>
      <li>{% if insp_ok %}✅{% else %}⏳{% endif %} Waiting for manager approval</li>

      {% if lot.status and lot.status|upper == "PARTIAL" %}
        <li>⚠️ Ticket is <b>PARTIAL</b>: remaining quantity can be received later using the same ticket.</li>
      {% endif %}
    </ul>
  </div>

  <!-- =========================
       BASIC INFO
  ========================== -->
  <div class="card inner mt">
    <h2>Basic Info</h2>
    <div class="kv"><span>Material</span><b>{{ lot.material_name or "-" }}</b></div>
    <div class="kv"><span>Supplier</span><b>{{ lot.supplier_name or "-" }}</b></div>
    <div class="kv"><span>PO</span><b>{{ lot.po_number or "-" }}</b></div>

    <div class="kv">
      <span>Used Delivery Note(s)</span>
      <b>
        {% if used_dns and used_dns|length > 0 %}
          {{ used_dns | join(", ") }}
        {% else %}
          -
        {% endif %}
      </b>
    </div>

    <div class="kv">
      <span>Quantity (PO)</span>
      <b>
        {{ lot.quantity if lot.quantity is not none else "-" }}
        {{ lot.quantity_unit or "" }}
      </b>
    </div>

    <div class="kv">
      <span>Received Total</span>
      <b>
        {{ lot.received_total if lot.received_total is not none else 0 }}
        {% if lot.quantity_unit and lot.quantity_unit|upper in ["PC","PCS"] %}
          {{ lot.quantity_unit }}
        {% else %}
          KG (normalized)
        {% endif %}
      </b>
    </div>
  </div>

  <!-- =========================
       DOCUMENTS
  ========================== -->
  <div class="card inner mt">
    <h2>Documents</h2>

    {% if docs and docs|length > 0 %}
      <div class="tablewrap mt">
        <table class="table wide">
          <thead>
            <tr>
              <th>Type</th>
              <th>Name</th>
              <th>No.</th>
              <th>By</th>
              <th>File</th>
            </tr>
          </thead>
          <tbody>
            {% for d in docs %}
              <tr>
                <td>{{ d.doc_type }}</td>
                <td>{{ d.doc_name }}</td>
                <td>{{ d.doc_number }}</td>
                <td>{{ d.uploaded_by }}</td>
                <td>
                  <a class="btn btn-ghost btn-small" href="/mrr/{{ lot.id }}/docs/{{ d.id }}/view">View</a>
                  <a class="btn btn-ghost btn-small" href="/mrr/{{ lot.id }}/docs/{{ d.id }}/download">Download</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="muted mt">No documents uploaded yet.</div>
    {% endif %}

    {% if not readonly %}
      <div class="toolbar mt">
        <a class="btn" href="/mrr/{{ lot.id }}/docs/upload">Upload Document</a>
      </div>
    {% endif %}
  </div>

  <!-- =========================
       SUBMITTED SHIPMENT REPORTS + PHOTOS
  ========================== -->
  <div class="card inner mt">
    <h2>Shipment Inspection Reports</h2>
    <div class="muted tiny">Anyone reviewing this ticket can see submitted shipment reports and photo evidence below.</div>

    {% if submitted_shipments and submitted_shipments|length > 0 %}
      <div class="tablewrap mt">
        <table class="table wide">
          <thead>
            <tr>
              <th>Shipment</th>
              <th>DN</th>
              <th>Arrived</th>
              <th>Report</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for s in submitted_shipments %}
              <tr>
                <td>#{{ loop.index }}</td>
                <td>{{ s.delivery_note_no or "-" }}</td>
                <td>{{ s.qty_arrived }} {{ s.qty_unit }}</td>
                <td><a class="btn btn-ghost btn-small" href="/mrr/{{ lot.id }}/inspection/id/{{ s.id }}">Open</a></td>
                <td>{% if s.manager_approved %}APPROVED{% else %}SUBMITTED{% endif %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <style>
        .photo-thumb { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; border: 1px solid rgba(0,0,0,0.08); }
        .photo-card { padding: 8px; }
        .btn-small { padding: 6px 10px; font-size: 12px; }
      </style>

      <div class="mt">
        {% for s in submitted_shipments %}
          {% set insp_photos = photos_by_inspection.get(s.id) %}
          {% if insp_photos %}
            <div class="card inner mt">
              <div class="sectiontitle accent-blue">Photos for DN: {{ s.delivery_note_no or "-" }} (Report: {{ s.report_no or "-" }})</div>
              {% for gname, items in insp_photos.items() %}
                <div class="mt">
                  <div class="sectiontitle">{{ gname }}</div>
                  <div class="grid3 mt">
                    {% for p in items %}
                      <div class="photo-card">
                        <a href="/mrr/photos/{{ p.id }}/view" target="_blank">
                          <img class="photo-thumb" src="/mrr/photos/{{ p.id }}/view" alt="photo">
                        </a>
                        {% if p.caption %}<div class="muted tiny mt">{{ p.caption }}</div>{% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
      </div>

    {% else %}
      <div class="muted mt">No submitted shipment inspections yet.</div>
    {% endif %}
  </div>

  <!-- =========================
       PROGRESS
  ========================== -->
  <div class="card inner mt">
    <h2>Progress</h2>

    <div class="kv">
      <span>Documentation</span>
      <b>{% if docs_ok %}CLEARED{% elif receiving %}SAVED{% else %}PENDING{% endif %}</b>
    </div>

    <div class="kv">
      <span>Receiving Inspection</span>
      <b>{% if insp_ok %}APPROVED{% elif insp_submitted %}SUBMITTED{% else %}PENDING{% endif %}</b>
    </div>

    <div class="mt muted">
      Ticket becomes <b>APPROVED</b> for production only after manager approves Receiving Inspection.
    </div>

    {% if not readonly %}
      <div class="toolbar mt">
        <a class="btn btn-primary" href="/mrr/{{ lot.id }}/inspection/new">
          {% if lot.status and lot.status|upper == "PARTIAL" %}
            New Shipment Inspection (Partial Delivery)
          {% else %}
            Start Shipment Inspection
          {% endif %}
        </a>
      </div>
    {% else %}
      <div class="muted mt">Inspection actions are disabled because this ticket is canceled.</div>
    {% endif %}

    {% if user.role and user.role|upper == "MANAGER" %}
      <a class="btn mt" href="/mrr/pending">View all pending approvals</a>
    {% endif %}
  </div>

</div>

{% endblock %}
