{% extends "base.html" %}
{% block content %}
<a class="btn btn-ghost" href="/dashboard">‚Üê Back</a>

<div class="card">
  {% if process %}
    <h1>Start New Production Run ({{ process }})</h1>
  {% else %}
    <h1>Start New Production Run</h1>
  {% endif %}

  {% if error %}
    <div class="alert">{{ error }}</div>
  {% endif %}

  <form method="post" action="{% if process %}/runs/new/{{ process }}{% else %}/runs/new{% endif %}" class="form">

    {% if not process %}
      <div class="field">
        <label>Process</label>
        <select name="process" required>
          <option value="">-- Select --</option>
          <option value="LINER">LINER</option>
          <option value="REINFORCEMENT">REINFORCEMENT</option>
          <option value="COVER">COVER</option>
        </select>
      </div>
    {% else %}
      <input type="hidden" name="process" value="{{ process }}">
    {% endif %}

    <div class="grid2">
      <div>
        <label>DHTP Batch No (Run Reference)</label>
        <input name="dhtp_batch_no" required>
      </div>
      <div>
        <label>Total Pipe Length (m) (for progress)</label>
        <input name="total_length_m" type="number" step="0.01" value="0">
      </div>
    </div>

    <div class="grid2 mt">
      <div><label>Client Name</label><input name="client_name" required></div>
      <div><label>PO Number</label><input name="po_number" required></div>
      <div><label>ITP Number</label><input name="itp_number" required></div>
      <div><label>Pipe Specification</label><input name="pipe_specification" required></div>
      <div><label>Raw Material Spec</label><input name="raw_material_spec" required></div>
    </div>

    <div class="card inner mt">
      <h2>Machines Used (set now)</h2>
      <div class="grid2">
        <div><label>Machine 1 Name</label><input name="machine1_name"></div>
        <div><label>Machine 1 Tag</label><input name="machine1_tag"></div>

        <div><label>Machine 2 Name</label><input name="machine2_name"></div>
        <div><label>Machine 2 Tag</label><input name="machine2_tag"></div>

        <div><label>Machine 3 Name</label><input name="machine3_name"></div>
        <div><label>Machine 3 Tag</label><input name="machine3_tag"></div>

        <div><label>Machine 4 Name</label><input name="machine4_name"></div>
        <div><label>Machine 4 Tag</label><input name="machine4_tag"></div>

        <div><label>Machine 5 Name</label><input name="machine5_name"></div>
        <div><label>Machine 5 Tag</label><input name="machine5_tag"></div>
      </div>
    </div>

    {% if process and param_defs and param_defs|length > 0 %}
      <div class="card inner mt">
        <h2>Parameter Limits (set now)</h2>
        <div class="muted">If you set these now, out-of-spec highlighting works immediately.</div>

        <div class="tablewrap mt">
          <table class="table">
            <thead>
              <tr>
                <th>Parameter</th>
                <th>Rule</th>
                <th>Min</th>
                <th>Max</th>
              </tr>
            </thead>
            <tbody>
              {% for p in param_defs %}
                {% set key = p[0] %}
                {% set label = p[1] %}
                {% set unit = p[2] %}
                <tr>
                  <td><b>{{ label }}</b> {% if unit %}<span class="muted">{{ unit }}</span>{% endif %}</td>
                  <td>
                    <select name="rule_{{ key }}">
                      <option value="RANGE" selected>RANGE</option>
                      <option value="MIN_ONLY">MIN_ONLY</option>
                      <option value="MAX_ONLY">MAX_ONLY</option>
                    </select>
                  </td>
                  <td><input name="min_{{ key }}" type="number" step="0.01" placeholder="optional"></td>
                  <td><input name="max_{{ key }}" type="number" step="0.01" placeholder="optional"></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    <div class="toolbar mt">
      <button class="btn btn-primary" type="submit">Create Run</button>
      <a class="btn" href="/dashboard">Cancel</a>
    </div>

  </form>
</div>
{% endblock %}
