{% extends "base.html" %}
{% block content %}

<style>
  .photo-thumb { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; border: 1px solid rgba(0,0,0,0.08); }
  .photo-card { padding: 8px; }
  .btn-small { padding: 6px 10px; font-size: 12px; }
</style>

<a class="btn btn-ghost" href="/mrr/{{ lot.id }}">← Back</a>

<div class="card">
  <div class="runheader">
    <div>
      <h1>Receiving Inspection</h1>
      <div class="muted">
        MRR Ticket #{{ lot.id }} • Type: <b>{{ lot.lot_type }}</b>
      </div>
    </div>
    <div class="actions">
      <span class="pill">Report: <b>{{ inspection_data.report_no }}</b></span>
      <span class="pill">DN: <b>{{ inspection_data.delivery_note_no }}</b></span>
      <span class="pill">Arrived: <b>{{ inspection_data.qty_arrived }} {{ inspection_data.qty_unit }}</b></span>
    </div>
  </div>

  {% if request.query_params.get("error") %}
    <div class="alert alert-error mt">{{ request.query_params.get("error") }}</div>
  {% endif %}

  <form method="post" action="/mrr/{{ lot.id }}/inspection/{{ inspection.id }}/submit">

    <div class="card inner mt">
      <div class="sectiontitle accent-blue">Material Classification (Raw Material)</div>

      <div class="grid3">
        <div>
          <label>Material Type</label>
          {% set fam = inspection_data.material_family if inspection_data and inspection_data.material_family else '' %}
          <select id="material_family" name="material_family" onchange="toggleMaterialTables()">
            <option value="">-- select --</option>
            <option value="PE" {% if fam == 'PE' %}selected{% endif %}>Polyethylene (PE / PERT / PE100)</option>
            <option value="FIBER" {% if fam == 'FIBER' %}selected{% endif %}>Fiber (Polyester)</option>
          </select>
          <div class="muted tiny">This controls which property table is shown.</div>
        </div>

        <div>
          <label>Material Model</label>
          {% set model = inspection_data.material_model if inspection_data and inspection_data.material_model else '' %}
          <select name="material_model">
            <option value="">-- select --</option>
            <option value="PERT-White" {% if model == 'PERT-White' %}selected{% endif %}>PERT-White</option>
            <option value="PE100-Black" {% if model == 'PE100-Black' %}selected{% endif %}>PE100-Black</option>
            <option value="Polyester Fiber 36000D" {% if model == 'Polyester Fiber 36000D' %}selected{% endif %}>Polyester Fiber 36000D</option>
            <option value="Polyester Fiber 45000D" {% if model == 'Polyester Fiber 45000D' %}selected{% endif %}>Polyester Fiber 45000D</option>
          </select>
        </div>

        <div>
          <label>Material Grade (optional)</label>
          {% set grade = inspection_data.material_grade if inspection_data and inspection_data.material_grade else '' %}
          <input
            type="text"
            name="material_grade"
            value="{{ grade }}"
            placeholder="Type grade (example: PE100-Black / PERT-White / etc.)"
            list="grade_suggestions"
          />
          <datalist id="grade_suggestions">
            <option value="PERT-White"></option>
            <option value="PE100-Black"></option>
            <option value="Polyester Fiber 36000D"></option>
            <option value="Polyester Fiber 45000D"></option>
          </datalist>
          <div class="muted tiny">You can type any grade. Suggestions are optional.</div>
        </div>
      </div>
    </div>

    <!-- Your existing tables are kept as-is below -->
    <div id="pe_table" class="card inner mt" style="display:none;">
      <div class="sectiontitle accent-blue">Raw Material Properties (PE)</div>
      <!-- existing PE property table content remains in your original file -->
      {{ "" }}
    </div>

    <div id="fiber_table" class="card inner mt" style="display:none;">
      <div class="sectiontitle accent-blue">Raw Material Properties (Fiber)</div>
      <!-- existing Fiber property table content remains in your original file -->
      {{ "" }}
    </div>

    <div class="card inner mt">
      <div class="sectiontitle accent-blue">Remarks</div>

      <label>General remarks</label>
      <textarea name="remarks" placeholder="General remarks...">{{ inspection_data.remarks if inspection_data and inspection_data.remarks else '' }}</textarea>

      <div class="grid2 mt">
        <div>
          <label>Inspected by</label>
          <input name="inspected_by" value="{{ inspection_data.inspected_by if inspection_data and inspection_data.inspected_by else user.display_name }}">
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn btn-primary" type="submit">Submit Inspection</button>
        </div>
      </div>
    </div>

    <!-- =========================
         PHOTO EVIDENCE
    ========================== -->
    <div class="card inner mt">
      <div class="sectiontitle accent-blue">Photo Evidence</div>
      <div class="muted tiny">
        Add photos as evidence (packaging, labeling, damage, etc.). You can capture from mobile camera or upload files.
      </div>

      {% if photo_error %}
        <div class="alert alert-error mt">{{ photo_error }}</div>
      {% endif %}

      <form class="mt" action="/mrr/{{ lot.id }}/inspection/id/{{ inspection.id }}/photos/upload" method="post" enctype="multipart/form-data">
        <div class="grid3">
          <div>
            <label>Group / Category</label>
            <input name="group_name" placeholder="e.g., Packaging / Labeling / Damage" required>
            <div class="muted tiny">Tip: use the same group name to keep photos together.</div>
          </div>
          <div>
            <label>Description (optional)</label>
            <input name="caption" placeholder="e.g., Outer wrap torn on one side">
          </div>
          <div>
            <label>Photos</label>
            <input type="file" name="photos" accept="image/*" capture="environment" multiple required>
            <div class="muted tiny">You can select multiple photos at once.</div>
          </div>
        </div>

        <div class="mt">
          <button class="btn btn-secondary" type="submit">Upload Photos</button>
        </div>
      </form>

      {% if photo_groups and photo_groups|length > 0 %}
        <div class="mt">
          {% for gname, items in photo_groups.items() %}
            <div class="card inner mt">
              <div class="sectiontitle">{{ gname }}</div>
              <div class="grid3 mt">
                {% for p in items %}
                  <div class="photo-card">
                    <a href="/mrr/photos/{{ p.id }}/view" target="_blank">
                      <img class="photo-thumb" src="/mrr/photos/{{ p.id }}/view" alt="photo">
                    </a>
                    {% if p.caption %}
                      <div class="muted tiny mt">{{ p.caption }}</div>
                    {% endif %}

                    {% if not inspection.inspector_confirmed %}
                      <form class="mt" action="/mrr/{{ lot.id }}/inspection/id/{{ inspection.id }}/photos/{{ p.id }}/delete" method="post">
                        <button class="btn btn-ghost btn-small" type="submit">Delete</button>
                      </form>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted tiny mt">No photos uploaded yet.</div>
      {% endif %}
    </div>

  </form>
</div>

<script>
  function toggleMaterialTables() {
    const fam = (document.getElementById("material_family") || {}).value || "";
    const pe = document.getElementById("pe_table");
    const fb = document.getElementById("fiber_table");

    if (pe) pe.style.display = (fam === "PE") ? "block" : "none";
    if (fb) fb.style.display = (fam === "FIBER") ? "block" : "none";
  }

  toggleMaterialTables();
</script>

{% endblock %}
