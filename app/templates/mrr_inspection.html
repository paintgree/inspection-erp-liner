{% extends "base.html" %}
{% block content %}

<a class="btn btn-ghost" href="/mrr/{{ lot.id }}">← Back</a>

<div class="card">
  <div class="runheader">
    <div>
      <h1>Receiving Inspection</h1>
      <div class="muted">
        MRR Ticket #{{ lot.id }} • Type: <b>{{ lot.lot_type }}</b>
      </div>
    </div>
    <div class="actions">
      <span class="pill">Report: <b>{{ inspection_data.report_no }}</b></span>
    </div>
  </div>

  <!-- ✅ IMPORTANT: submit to the correct route -->
  <form method="post" action="/mrr/{{ lot.id }}/inspection/{{ inspection.id }}/submit" class="mt">

    <!-- =========================
         Header (Auto)
    ========================== -->
    <div class="card inner">
      <div class="sectiontitle accent-blue">Header (auto-filled from Ticket + Shipment)</div>

      <div class="grid3 mt">
        <div>
          <label>Report Number</label>
          <input value="{{ inspection_data.report_no }}" readonly>
        </div>

        <div>
          <label>Purchase Order</label>
          <input value="{{ lot.po_number }}" readonly>
        </div>

        <div>
          <label>Delivery Note (this shipment)</label>
          <input name="delivery_note" value="{{ inspection.delivery_note_no or inspection_data.delivery_note_no or '' }}" readonly>
          <div class="muted tiny">To change DN, create a new shipment inspection.</div>
        </div>
      </div>

      <div class="grid3 mt">
        <div>
          <label>PO Quantity</label>
          <input value="{{ lot.quantity }} {{ lot.quantity_unit }}" readonly>
        </div>

        <div>
          <label>Quantity Arrived (this shipment)</label>
          <input name="qty_arrived" type="number" step="0.01"
                 value="{{ inspection.qty_arrived if inspection and inspection.qty_arrived is not none else (inspection_data.qty_arrived if inspection_data.qty_arrived is not none else '') }}"
                 required>
        </div>

        <div>
          <label>Unit</label>
          <select name="qty_unit" required>
            {% set u = (inspection.qty_unit if inspection and inspection.qty_unit else inspection_data.qty_unit) %}
            <option value="KG" {% if (u or '') == 'KG' %}selected{% endif %}>KG</option>
            <option value="T"  {% if (u or '') == 'T' %}selected{% endif %}>Ton (T)</option>
            <option value="PC" {% if (u or '') == 'PC' %}selected{% endif %}>PC</option>
          </select>
          <div class="muted tiny">Unit conversions are handled automatically when compatible (KG ↔ T).</div>
        </div>
      </div>

      <div class="mt">
        {% set partial = inspection_data.is_partial_delivery if inspection_data and inspection_data.is_partial_delivery is not none else False %}
        <label>
          <input type="checkbox" name="is_partial_delivery" {% if partial %}checked{% endif %}>
          Partial delivery (ticket stays open)
        </label>
      </div>

      <div class="mt">
        <label>If quantity mismatch / partial delivery – Reason (required if arrived &gt; PO)</label>
        <textarea name="qty_mismatch_reason" placeholder="Explain mismatch / partial delivery...">{{ inspection_data.qty_mismatch_reason if inspection_data and inspection_data.qty_mismatch_reason else '' }}</textarea>
      </div>
    </div>

    <!-- =========================
         Material Classification (NEW)
    ========================== -->
    <div class="card inner mt">
      <div class="sectiontitle accent-blue">Material Classification (Raw Material)</div>

      <div class="grid3 mt">
        <div>
          <label>Material Type</label>
          {% set fam = inspection_data.material_family if inspection_data and inspection_data.material_family else '' %}
          <select name="material_family" id="material_family" required>
            <option value="">-- select --</option>
            <option value="PE" {% if fam == 'PE' %}selected{% endif %}>Polyethylene (PE / PERT / PE100)</option>
            <option value="FIBER" {% if fam == 'FIBER' %}selected{% endif %}>Polyester Fiber</option>
          </select>
          <div class="muted tiny">This controls which property table is shown.</div>
        </div>

        <div>
          <label>Material Model</label>
          {% set model = inspection_data.material_model if inspection_data and inspection_data.material_model else '' %}
          <select name="material_model" id="material_model" required>
            <option value="">-- select --</option>
            <option value="PERT_WHITE" {% if model == 'PERT_WHITE' %}selected{% endif %}>PERT-White</option>
            <option value="PE100_BLACK" {% if model == 'PE100_BLACK' %}selected{% endif %}>PE100-Black</option>
            <option value="FIBER_36000D" {% if model == 'FIBER_36000D' %}selected{% endif %}>Polyester Fiber 36000D</option>
            <option value="FIBER_45000D" {% if model == 'FIBER_45000D' %}selected{% endif %}>Polyester Fiber 45000D</option>
          </select>
          <div class="muted tiny">We’ll later link these models to LINER / REINFORCEMENT / COVER usage rules.</div>
        </div>

        <div>
          <label>Intended Process (optional)</label>
          {% set ip = inspection_data.intended_process if inspection_data and inspection_data.intended_process else '' %}
          <select name="intended_process">
            <option value="" {% if ip == '' %}selected{% endif %}>-- optional --</option>
            <option value="LINER" {% if ip == 'LINER' %}selected{% endif %}>LINER</option>
            <option value="REINFORCEMENT" {% if ip == 'REINFORCEMENT' %}selected{% endif %}>REINFORCEMENT</option>
            <option value="COVER" {% if ip == 'COVER' %}selected{% endif %}>COVER</option>
          </select>
        </div>
      </div>
    </div>

    <!-- =========================
         Properties Table - PE (from your Excel)
    ========================== -->
    <div class="card inner mt" id="pe_table" style="display:none;">
      <div class="sectiontitle accent-green">Raw Material Properties (PE)</div>

      <div class="tablewrap mt">
        <table class="table wide">
          <thead>
            <tr>
              <th>Property</th>
              <th>Unit</th>
              <th class="wrap">Test Method</th>
              <th class="wrap">Acceptance Criteria</th>
              <th class="wrap">PDS/COA Results</th>
              <th class="wrap">Remarks</th>
            </tr>
          </thead>
          <tbody>
            {% set pe_rows = [
              {"k":"density","p":"Density","u":"g/cm³","m":"ASTM D1505 / ISO-1183","a":"0.935–0.965 g/cm³"},
              {"k":"mfr","p":"Melt Flow Rate (MFR) -190°C / 5kg","u":"g/10 min","m":"ASTM D1238 / ISO 1133","a":"0.2–0.4 g/10 min"},
              {"k":"flexural","p":"Flexural Modulus","u":"MPa","m":"ASTM D790","a":"700–1200 MPa"},
              {"k":"t_yield","p":"Tensile Strength at Yield","u":"MPa","m":"ISO 527-2","a":"≥ 19 MPa"},
              {"k":"t_break","p":"Tensile Strength at Break","u":"MPa","m":"ISO 527-2","a":"> 22 MPa"},
              {"k":"elong","p":"Elongation at Break","u":"%","m":"ISO 527-2","a":"≥ 350%"},
              {"k":"escr","p":"(ESCR)","u":"Hours","m":"ASTM D1693","a":"≥ 1000 hrs"},
              {"k":"oit","p":"Oxidative Induction Time (OIT)","u":"Minutes","m":"ASTM D3895","a":"≥ 20 min"},
              {"k":"hdb","p":"HDB (23C°) / MRS (20C°)","u":"MPa","m":"ISO 12162","a":"10.0 MPa"},
              {"k":"cbc","p":"Carbon Black Content","u":"%","m":"ISO 6964","a":"%"},
              {"k":"mp","p":"Melting Point","u":"C°","m":"","a":""}
            ] %}

            {% for r in pe_rows %}
              <tr>
                <td><b>{{ r.p }}</b></td>
                <td>{{ r.u }}</td>
                <td class="wrap">{{ r.m }}</td>
                <td class="wrap">{{ r.a }}</td>
                <td class="wrap">
                  <input name="pe_result__{{ r.k }}" value="{{ inspection_data['pe_result__' ~ r.k] if inspection_data and ('pe_result__' ~ r.k) in inspection_data else '' }}" placeholder="Enter result...">
                </td>
                <td class="wrap">
                  <input name="pe_remark__{{ r.k }}" value="{{ inspection_data['pe_remark__' ~ r.k] if inspection_data and ('pe_remark__' ~ r.k) in inspection_data else '' }}" placeholder="Remarks...">
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- =========================
         Properties Table - FIBER (from your Excel)
    ========================== -->
    <div class="card inner mt" id="fiber_table" style="display:none;">
      <div class="sectiontitle accent-green">Raw Material Properties (Fiber)</div>

      <div class="tablewrap mt">
        <table class="table wide">
          <thead>
            <tr>
              <th>Property</th>
              <th>Unit</th>
              <th class="wrap">Test Method</th>
              <th class="wrap">Acceptance Criteria</th>
              <th class="wrap">PDS/COA Results</th>
              <th class="wrap">Remarks</th>
            </tr>
          </thead>
          <tbody>
            {% set fiber_rows = [
              {"k":"linear_density","p":"Linear Density","u":"dtex","m":"GB/T 16604-2008","a":""},
              {"k":"breaking_strength","p":"Breaking Strength","u":"cN","m":"GB/T 16604-2008","a":""},
              {"k":"tenacity","p":"Tenacity","u":"cN/dtex","m":"GB/T 16604-2008","a":""},
              {"k":"elong_break","p":"Elongation at Break","u":"%","m":"GB/T 16604-2008","a":""},
              {"k":"mp","p":"Melting Point","u":"C°","m":"","a":""}
            ] %}

            {% for r in fiber_rows %}
              <tr>
                <td><b>{{ r.p }}</b></td>
                <td>{{ r.u }}</td>
                <td class="wrap">{{ r.m }}</td>
                <td class="wrap">{{ r.a }}</td>
                <td class="wrap">
                  <input name="fiber_result__{{ r.k }}" value="{{ inspection_data['fiber_result__' ~ r.k] if inspection_data and ('fiber_result__' ~ r.k) in inspection_data else '' }}" placeholder="Enter result...">
                </td>
                <td class="wrap">
                  <input name="fiber_remark__{{ r.k }}" value="{{ inspection_data['fiber_remark__' ~ r.k] if inspection_data and ('fiber_remark__' ~ r.k) in inspection_data else '' }}" placeholder="Remarks...">
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- =========================
         Visual & Physical Inspection (keep your existing section)
    ========================== -->
    <div class="card inner mt">
      <div class="sectiontitle accent-green">Visual & Physical Inspection</div>

      <div class="grid2 mt">
        <div class="fieldbox">
          <label>Packaging condition OK?</label>
          <select name="packaging_ok" required>
            <option value="">-- select --</option>
            <option value="YES" {% if inspection_data.packaging_ok=='YES' %}selected{% endif %}>YES</option>
            <option value="NO" {% if inspection_data.packaging_ok=='NO' %}selected{% endif %}>NO</option>
          </select>

          <label class="mt">Identification / marking as per specification?</label>
          <select name="marking_ok" required>
            <option value="">-- select --</option>
            <option value="YES" {% if inspection_data.marking_ok=='YES' %}selected{% endif %}>YES</option>
            <option value="NO" {% if inspection_data.marking_ok=='NO' %}selected{% endif %}>NO</option>
          </select>

          <label class="mt">Any physical damage / contamination?</label>
          <select name="damage_ok" required>
            <option value="">-- select --</option>
            <option value="NO_DAMAGE" {% if inspection_data.damage_ok=='NO_DAMAGE' %}selected{% endif %}>No damage</option>
            <option value="HAS_DAMAGE" {% if inspection_data.damage_ok=='HAS_DAMAGE' %}selected{% endif %}>Has issues</option>
          </select>
        </div>

        <div class="fieldbox">
          <label>Quantity matches delivery?</label>
          <select name="qty_ok" required>
            <option value="">-- select --</option>
            <option value="YES" {% if inspection_data.qty_ok=='YES' %}selected{% endif %}>YES</option>
            <option value="NO" {% if inspection_data.qty_ok=='NO' %}selected{% endif %}>NO</option>
          </select>

          <label class="mt">COA / PDS available and acceptable?</label>
          <select name="coa_ok" required>
            <option value="">-- select --</option>
            <option value="YES" {% if inspection_data.coa_ok=='YES' %}selected{% endif %}>YES</option>
            <option value="NO" {% if inspection_data.coa_ok=='NO' %}selected{% endif %}>NO</option>
          </select>

          <label class="mt">Material status</label>
          <select name="material_status" required>
            <option value="">-- select --</option>
            <option value="VERIFIED_CONFIRMED" {% if inspection_data.material_status=='VERIFIED_CONFIRMED' %}selected{% endif %}>Verified and Confirmed</option>
            <option value="ON_HOLD" {% if inspection_data.material_status=='ON_HOLD' %}selected{% endif %}>On Hold</option>
            <option value="NON_CONFORMITY" {% if inspection_data.material_status=='NON_CONFORMITY' %}selected{% endif %}>Non-Conformity</option>
          </select>
        </div>
      </div>

      <div class="mt">
        <label>If On Hold / Non-Conformity: Reason / Comments</label>
        <textarea name="hold_comments" placeholder="Write reason / NCR reference / actions...">{{ inspection_data.hold_comments if inspection_data and inspection_data.hold_comments else '' }}</textarea>
      </div>
    </div>

    <!-- =========================
         Remarks + submit
    ========================== -->
    <div class="card inner mt">
      <div class="sectiontitle accent-blue">Remarks</div>

      <label>General remarks</label>
      <textarea name="remarks" placeholder="General remarks...">{{ inspection_data.remarks if inspection_data and inspection_data.remarks else '' }}</textarea>

      <div class="grid2 mt">
        <div>
          <label>Inspected by</label>
          <input name="inspected_by" value="{{ inspection_data.inspected_by if inspection_data and inspection_data.inspected_by else user.display_name }}">
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn btn-primary" type="submit">Submit Inspection</button>
        </div>
      </div>
    </div>

  </form>
</div>

<script>
  function toggleMaterialTables() {
    const fam = (document.getElementById("material_family") || {}).value || "";
    const pe = document.getElementById("pe_table");
    const fb = document.getElementById("fiber_table");

    if (pe) pe.style.display = (fam === "PE") ? "block" : "none";
    if (fb) fb.style.display = (fam === "FIBER") ? "block" : "none";
  }

  // Run on load and on change
  document.addEventListener("DOMContentLoaded", function () {
    const famSel = document.getElementById("material_family");
    if (famSel) famSel.addEventListener("change", toggleMaterialTables);
    toggleMaterialTables();
  });
</script>

{% endblock %}
