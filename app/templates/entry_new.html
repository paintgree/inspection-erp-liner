{% extends "base.html" %}
{% block content %}
<a class="btn btn-ghost" href="/runs/{{ run.id }}">← Back</a>

<div class="card">
  <h1>Inspection Data Entry</h1>

  {% if error %}
    <div class="alert mt">{{ error }}</div>
  {% endif %}

  <form method="post" action="/runs/{{ run.id }}/entry/new" class="form">

    <div class="grid2 mt">
      <div>
        <label>Actual Date</label>
        <input type="date" name="actual_date" required>
      </div>
      <div>
        <label>Actual Time</label>
        <input type="time" name="actual_time" step="60" required>
      </div>
    </div>

    <div class="grid2 mt">
      <div>
        <label>QC Inspector (Locked)</label>
        <input value="{{ user.display_name }}" disabled>
      </div>
      <div>
        <label>Remarks</label>
        <input name="remarks" placeholder="Optional">
      </div>
    </div>

    {% if run.process in ["LINER", "COVER"] %}
      <div class="card inner mt">
        <div class="sectiontitle accent-purple">Operators</div>

        <div class="grid2 mt">
          <div>
            <label>Operator (Hopper)</label>
            <input name="operator_1" placeholder="Name">
          </div>
          <div>
            <label>Operator (Extruder)</label>
            <input name="operator_2" placeholder="Name">
          </div>
        </div>

        <div class="grid2 mt">
          <div>
            <label>Operator (Cooling)</label>
            <input name="operator_annular_12" placeholder="Name">
          </div>
          <div>
            <label>Operator (Accumulator)</label>
            <input name="operator_int_ext_34" placeholder="Name">
          </div>
        </div>
      </div>

      <div class="card inner mt">
        <div class="sectiontitle accent-blue">Standard Parameters</div>
        <div class="grid3 mt">
          {% for p in params %}
            {% if p.param_key in ["length_m","od_mm","wall_thickness_mm","cooling_water_c","line_speed_m_min","tractor_pressure_mpa"] %}
              <div class="fieldbox">
                <div class="labelmini">
                  {{ p.label }}
                  {% if p.unit %}<span class="muted">{{ p.unit }}</span>{% endif %}
                </div>
                <input type="number" step="0.01" name="v_{{ p.param_key }}" placeholder="Enter value...">
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <div class="card inner mt">
        <div class="grid2">
          <div>
            <div class="sectiontitle accent-orange">Body Temperature (°C)</div>
            <div class="barrels mt">
              {% for i in [1,2,3,4,5] %}
                <div class="barrel">
                  <div class="barrelhead">Barrel {{ i }}</div>
                  <input type="number" step="0.01" name="v_body_temp_zone_{{ i }}_c">
                </div>
              {% endfor %}
            </div>
          </div>

          <div>
            <div class="sectiontitle accent-green">Noising Temperature (°C)</div>
            <div class="barrels mt">
              {% for i in [1,2,3,4,5] %}
                <div class="barrel">
                  <div class="barrelhead">Barrel {{ i }}</div>
                  <input type="number" step="0.01" name="v_noising_temp_zone_{{ i }}_c">
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="card inner mt">
        <div class="sectiontitle accent-blue">Reinforcement Parameters</div>
        <div class="grid3 mt">
          {% for p in params %}
            <div class="fieldbox">
              <div class="labelmini">
                {{ p.label }}
                {% if p.unit %}<span class="muted">{{ p.unit }}</span>{% endif %}
              </div>
              <input type="number" step="0.01" name="v_{{ p.param_key }}" placeholder="Enter value...">
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- ✅ Raw Material selection = ONLY APPROVED RAW lots -->
    <div class="card inner mt">
      <div class="sectiontitle accent-purple">Raw Material (MRR Approved)</div>

      {% if not has_any_event %}
      <div class="muted">
        No batch selected yet for this run. Please select the starting batch below.
      </div>
    {% else %}
      <div class="muted">
        This run already has a selected batch. If the batch changed during this inspection, tick the box to record the new batch.
      </div>
    {% endif %}

      <!-- starting batch (only required when no previous events exist) -->
      {% if not current_lot_preview %}
        <div class="mt">
          <label>Starting approved batch (required for first entry)</label>
          <select name="start_lot_id" required>
            <option value="">-- select approved RAW batch --</option>
            {% for lot in approved_lots %}
              <option value="{{ lot.id }}">{{ lot.batch_no }}{% if lot.material_name %} — {{ lot.material_name }}{% endif %}</option>
            {% endfor %}
          </select>
        </div>
      {% endif %}

      <!-- batch change event (this is what makes “both batches used in the same day” appear) -->
      <div class="mt">
        <label style="display:flex; gap:10px; align-items:center;">
          <input id="batch_changed" type="checkbox" name="batch_changed" value="1">
          Batch changed during this inspection?
        </label>

        <div id="batchSelectWrap" style="display:none; margin-top:10px;">
          <label>Select NEW approved RAW batch</label>
          <select id="new_lot_id" name="new_lot_id">
            <option value="">-- select approved RAW batch --</option>
            {% for lot in approved_lots %}
              <option value="{{ lot.id }}">{{ lot.batch_no }}{% if lot.material_name %} — {{ lot.material_name }}{% endif %}</option>
            {% endfor %}
          </select>
          <div class="muted" style="margin-top:6px;">
            This creates a “MaterialUseEvent”, so your run page will show BOTH batches used that day.
          </div>
        </div>
      </div>

      <script>
        (function(){
          const chk = document.getElementById("batch_changed");
          const wrap = document.getElementById("batchSelectWrap");
          const sel = document.getElementById("new_lot_id");
          if (!chk || !wrap || !sel) return;

          function sync(){
            if (chk.checked){
              wrap.style.display = "block";
              sel.setAttribute("required","required");
            } else {
              wrap.style.display = "none";
              sel.removeAttribute("required");
              sel.value = "";
            }
          }
          chk.addEventListener("change", sync);
          sync();
        })();
      </script>
    </div>

    <div class="card inner mt">
      <div class="sectiontitle accent-purple">Daily Traceability (Tools)</div>

      <div class="toolgrid mt">
        <div class="toolcard">
          <div class="tooltitle">Tool 1</div>
          <label>Name</label><input name="tool1_name">
          <label>Serial</label><input name="tool1_serial">
          <label>Calibration Due (YYYY-MM-DD)</label><input name="tool1_calib_due">
        </div>

        <div class="toolcard">
          <div class="tooltitle">Tool 2</div>
          <label>Name</label><input name="tool2_name">
          <label>Serial</label><input name="tool2_serial">
          <label>Calibration Due (YYYY-MM-DD)</label><input name="tool2_calib_due">
        </div>
      </div>
    </div>

    <div class="toolbar mt">
      <button class="btn btn-primary" type="submit">Commit</button>
      <a class="btn" href="/runs/{{ run.id }}">Cancel</a>
    </div>

  </form>
</div>
{% endblock %}


