{% extends "base.html" %}
{% block content %}

<a class="btn btn-ghost" href="/mrr/{{ lot.id }}">← Back</a>

<div class="card mt">
  <div class="runheader">
    <div>
      <h1>Documentation</h1>
      <div class="muted">
        MRR Ticket #{{ lot.id }} • Type: <b>{{ lot.lot_type }}</b>
      </div>
    </div>
  </div>

  <!-- Uploaded Documents List -->
  <div class="card inner mt">
    <div class="sectiontitle accent-blue">Uploaded Documents</div>

    {% if docs and docs|length > 0 %}
      <div class="tablewrap mt">
        <table class="table wide">
          <thead>
            <tr>
              <th>Type</th>
              <th>No.</th>
              <th>Name</th>
              <th>Uploaded By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for d in docs %}
              <tr>
                <td><b>{{ d.doc_type }}</b></td>
                <td>{{ d.doc_number or "-" }}</td>
                <td>{{ d.doc_name or "-" }}</td>
                <td>{{ d.uploaded_by_user_name or "-" }}</td>
                <td>
                  <a class="btn btn-sm" href="/mrr/docs/{{ d.id }}/view">View</a>
                  <a class="btn btn-sm" href="/mrr/docs/{{ d.id }}/download">Download</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="muted mt">No documents uploaded yet.</div>
    {% endif %}
  </div>

  <!-- Upload Form -->
  <div class="card inner mt">
    <div class="sectiontitle accent-blue">Upload Document</div>

    {% if readonly %}
      <div class="muted mt">Actions disabled (ticket canceled).</div>
    {% else %}

      <form class="mt" action="/mrr/{{ lot.id }}/docs/upload" method="post" enctype="multipart/form-data">

        <div class="grid3">
          <div>
            <label>Document Type</label>
            <select name="doc_type" required id="docType">
              <option value="PO">PO</option>
              <option value="DELIVERY_NOTE">DELIVERY NOTE</option>
              <option value="COA">COA</option>
              <option value="RELATED">RELATED</option>
              <option value="GENERAL" selected>GENERAL</option>
            </select>
          </div>

          <div>
            <label>Document Title (optional)</label>
            <input name="doc_title" id="docTitle" placeholder="Auto (except RELATED)">
            <div class="muted tiny">If you choose RELATED, Document Title becomes required.</div>
          </div>

          <div>
            <label>Document Number (optional)</label>
            <input name="doc_number" id="docNumber" placeholder="Optional (PO is auto)">
          </div>
        </div>

        <div class="grid3 mt">
          <div>
            <label>Attach uploads to</label>
            <select name="attach_to" id="attachTo">
              <option value="AUTO">AUTO (Latest Draft Shipment)</option>
              <option value="SHIPMENT">Choose Shipment</option>
              <option value="TICKET">Ticket-level (Shared)</option>
            </select>
            <div class="muted tiny mt">Tip: Use “Choose Shipment” to attach DN/COA to an older shipment.</div>
          </div>

          <div>
            <label>Shipment (if Choose Shipment)</label>
            <select name="attach_inspection_id" id="attachInspection">
              <option value="">-- Select Shipment --</option>
              {% if inspections %}
                {% for s in inspections %}
                  {% set label = "Shipment #" ~ loop.index ~ " • " ~ (s.report_no or ("ID " ~ s.id)) %}
                  {% if s.delivery_note_no %}
                    {% set label = label ~ " • DN " ~ s.delivery_note_no %}
                  {% endif %}
                  <option value="{{ s.id }}" {% if default_insp_id and s.id == default_insp_id %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              {% endif %}
            </select>
          </div>

          <div>
            <label>File</label>
            <input type="file" name="file" required>
          </div>
        </div>

        <div class="mt">
          <button class="btn btn-secondary" type="submit">Upload</button>
        </div>

      </form>

      <script>
      (function(){
        const docType = document.getElementById("docType");
        const docTitle = document.getElementById("docTitle");
        const docNumber = document.getElementById("docNumber");
        const attachTo = document.getElementById("attachTo");
        const attachInspection = document.getElementById("attachInspection");

        function applyDocRules(){
          const t = (docType.value || "").toUpperCase();

          // RELATED requires title
          if(t === "RELATED"){
            docTitle.required = true;
            docTitle.placeholder = "Required for RELATED";
          } else {
            docTitle.required = false;
            docTitle.placeholder = "Auto (except RELATED)";
          }

          // Delivery Note requires number
          const isDN = (t === "DELIVERY_NOTE");
          docNumber.required = isDN;
          docNumber.placeholder = isDN ? "Required (DN Number)" : "Optional (PO is auto)";

          // PO must be ticket-level
          if(t === "PO"){
            attachTo.value = "TICKET";
            attachTo.disabled = true;
            attachInspection.disabled = true;
            attachInspection.value = "";
            return;
          } else {
            attachTo.disabled = false;
          }
        }

        function applyAttachRules(){
          const mode = (attachTo.value || "AUTO").toUpperCase();
          if(mode === "SHIPMENT"){
            attachInspection.disabled = false;
          } else {
            attachInspection.disabled = true;
            attachInspection.value = "";
          }
        }

        // apply initial selection from backend
        const initialAttachTo = "{{ (initial_attach_to or 'AUTO') }}".toUpperCase();
        if(initialAttachTo === "AUTO" || initialAttachTo === "SHIPMENT" || initialAttachTo === "TICKET"){
          attachTo.value = initialAttachTo;
        }

        docType.addEventListener("change", function(){
          applyDocRules();
          applyAttachRules();
        });

        attachTo.addEventListener("change", function(){
          applyAttachRules();
        });

        applyDocRules();
        applyAttachRules();
      })();
      </script>

    {% endif %}
  </div>

  <!-- PO Check + Confirm moved here (instead of ticket page) -->
  <div class="card inner mt">
    <div class="sectiontitle accent-blue">Checklist & PO Verification</div>

    {% if readonly %}
      <div class="muted mt">Actions disabled (ticket canceled).</div>
    {% else %}
      <div class="kv"><span>Ticket PO number</span><b>{{ lot.po_number or "-" }}</b></div>
      <div class="kv"><span>Inspector entered PO</span><b>{{ receiving.inspector_po_number if receiving else "-" }}</b></div>
      <div class="kv"><span>PO Match</span>
        <b>
          {% if receiving and receiving.po_match %}YES{% else %}NO{% endif %}
        </b>
      </div>

      <form class="mt" action="/mrr/{{ lot.id }}/docs/submit_and_confirm" method="post"
            onsubmit="return confirm('Save PO number and confirm documentation? (Requires PO uploaded + PO match)');">
        <label>Inspector PO Number (type it exactly like the ticket PO)</label>
        <input name="inspector_po_number" required value="{{ receiving.inspector_po_number if receiving else '' }}">
        <div class="mt">
          <button class="btn btn-primary" type="submit">Inspector Confirm Documentation</button>
        </div>
      </form>

      {% if user.role and user.role|upper == "MANAGER" %}
        <form class="mt" action="/mrr/{{ lot.id }}/docs/approve" method="post"
              onsubmit="return confirm('Manager approve documentation?');">
          <button class="btn btn-warn" type="submit">Manager Approve Documentation</button>
        </form>
      {% endif %}
    {% endif %}
  </div>

</div>

{% endblock %}
