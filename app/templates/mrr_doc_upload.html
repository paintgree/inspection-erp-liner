{% extends "base.html" %}
{% block content %}

<a class="btn btn-ghost" href="/mrr/{{ lot.id }}">← Back</a>

<div class="card mt">
  <div class="runheader">
    <div>
      <h1>Documentation</h1>
      <div class="muted">
        MRR Ticket #{{ lot.id }} • Type: <b>{{ lot.lot_type }}</b>
      </div>
    </div>
  </div>

  <!-- Uploaded Documents List -->
  <div class="card inner mt">
    <div class="sectiontitle accent-blue">Uploaded Documents</div>

    {% if docs and docs|length > 0 %}
      <table class="table mt">
        <thead>
          <tr>
            <th>Type</th>
            <th>No.</th>
            <th>Name</th>
            <th>Uploaded By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for d in docs %}
            <tr>
              <td><b>{{ d.doc_type }}</b></td>
              <td>{{ d.doc_number or "-" }}</td>
              <td>{{ d.doc_name or "-" }}</td>
              <td>{{ d.uploaded_by_user_name or "-" }}</td>
              <td>
                <a class="btn btn-sm" href="/mrr/docs/{{ d.id }}/view">View</a>
                <a class="btn btn-sm" href="/mrr/docs/{{ d.id }}/download">Download</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="muted mt">No documents uploaded yet.</div>
    {% endif %}
  </div>

  <!-- Upload Form -->
  <div class="card inner mt">
    <div class="sectiontitle accent-blue">Upload Document</div>

    {% if readonly %}
      <div class="muted mt">Actions disabled (ticket canceled).</div>
    {% else %}
      <form class="mt" action="/mrr/{{ lot.id }}/docs/upload" method="post" enctype="multipart/form-data">
        <div class="grid3">
          <div>
            <label>Document Type</label>
            <select name="doc_type" required>
              <option value="PO">PO</option>
              <option value="DELIVERY_NOTE">DELIVERY NOTE</option>
              <option value="COA">COA</option>
              <option value="RELATED">RELATED</option>
              <option value="GENERAL" selected>GENERAL</option>
            </select>
          </div>
          <div>
            <label>Document Title (optional)</label>
            <input name="doc_title" placeholder="e.g., Supplier COA">
          </div>
          <div>
            <label>Document Number (optional)</label>
            <input name="doc_number" placeholder="e.g., COA-2026-001">
          </div>
        </div>

        <div class="mt">
          <label>File</label>
          <input type="file" name="file" required>
        </div>

        <div class="mt">
          <button class="btn btn-secondary" type="submit">Upload</button>
        </div>
      </form>
    {% endif %}
  </div>

  <!-- Checklist / PO Verification -->
  <div class="card inner mt">
    <div class="sectiontitle accent-blue">Checklist & PO Verification</div>

    {% set has_po = false %}
    {% if docs %}
      {% for d in docs %}
        {% if d.doc_type == "PO" %}
          {% set has_po = true %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <div class="mt">
      <div class="kv"><span>PO document uploaded</span><b>{% if has_po %}YES{% else %}NO{% endif %}</b></div>
      <div class="kv"><span>Ticket PO number</span><b>{{ lot.po_number or "-" }}</b></div>
      <div class="kv"><span>Inspector entered PO</span><b>{{ receiving.inspector_po_number if receiving else "-" }}</b></div>
      <div class="kv"><span>PO Match</span><b>{% if receiving and receiving.po_match %}YES{% else %}NO{% endif %}</b></div>
    </div>

    {% if not readonly %}
      <form class="mt" action="/mrr/{{ lot.id }}/docs/submit" method="post">
        <label>Inspector PO Number (type it exactly like the ticket PO)</label>
        <input name="inspector_po_number" required value="{{ receiving.inspector_po_number if receiving else '' }}">
        <div class="mt">
          <button class="btn" type="submit">Save PO Check</button>
        </div>
      </form>

      <form class="mt" action="/mrr/{{ lot.id }}/docs/confirm" method="post"
            onsubmit="return confirm('Confirm documentation? This requires PO uploaded + PO match.')">
        <button class="btn btn-primary" type="submit">Inspector Confirm Documentation</button>
      </form>

      {% if user.role and user.role|upper == "MANAGER" %}
        <form class="mt" action="/mrr/{{ lot.id }}/docs/approve" method="post"
              onsubmit="return confirm('Manager approve documentation?')">
          <button class="btn btn-warn" type="submit">Manager Approve Documentation</button>
        </form>
      {% endif %}
    {% endif %}
  </div>

  <script>
    const docType = document.querySelector('select[name="doc_type"]');
    const docNumber = document.querySelector('input[name="doc_number"]');
  
    function toggleDocNumberRequired() {
      const isDN = (docType.value || "").toUpperCase() === "DELIVERY_NOTE";
      docNumber.required = isDN;
      docNumber.placeholder = isDN ? "Required (must match Delivery Note Number exactly)" : "e.g., COA-2026-001";
    }
  
    docType.addEventListener("change", toggleDocNumberRequired);
    toggleDocNumberRequired();
  </script>

</div>

{% endblock %}

