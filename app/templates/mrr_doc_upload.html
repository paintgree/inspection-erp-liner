{% extends "base.html" %}
{% block content %}

<a class="btn btn-ghost" href="/mrr/{{ lot.id }}">← Back</a>

<div class="card mt">
  <div class="runheader">
    <div>
      <h1>Documentation</h1>
      <div class="muted">
        MRR Ticket #{{ lot.id }} • Type: <b>{{ lot.lot_type }}</b>
      </div>
    </div>
  </div>

  <!-- Uploaded Documents List -->
  <div class="card inner mt">
    <div class="sectiontitle accent-blue">Uploaded Documents</div>

    {% if docs and docs|length > 0 %}
      <table class="table mt">
        <thead>
          <tr>
            <th>Type</th>
            <th>No.</th>
            <th>Name</th>
            <th>Uploaded By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for d in docs %}
            <tr>
              <td><b>{{ d.doc_type }}</b></td>
              <td>{{ d.doc_number or "-" }}</td>
              <td>{{ d.doc_name or "-" }}</td>
              <td>{{ d.uploaded_by_user_name or "-" }}</td>
              <td>
                <a class="btn btn-sm" href="/mrr/docs/{{ d.id }}/view">View</a>
                <a class="btn btn-sm" href="/mrr/docs/{{ d.id }}/download">Download</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="muted mt">No documents uploaded yet.</div>
    {% endif %}
  </div>

  <!-- Upload Form -->
  <div class="card inner mt">
    <div class="sectiontitle accent-blue">Upload Document</div>

    {% if readonly %}
      <div class="muted mt">Actions disabled (ticket canceled).</div>
    {% else %}
      <form class="mt" action="/mrr/{{ lot.id }}/docs/upload" method="post" enctype="multipart/form-data">
      
        <div class="grid3">
          <div>
            <label>Document Type</label>
            <select name="doc_type" required id="docType">
              <option value="PO">PO</option>
              <option value="DELIVERY_NOTE">DELIVERY NOTE</option>
              <option value="COA">COA</option>
              <option value="RELATED">RELATED</option>
              <option value="GENERAL" selected>GENERAL</option>
            </select>
          </div>
      
          <div>
            <label>Document Title (optional)</label>
            <input name="doc_title" placeholder="e.g., Supplier COA">
          </div>
      
          <div>
            <label>Document Number (optional)</label>
            <input name="doc_number" id="docNumber" placeholder="e.g., COA-2026-001">
          </div>
        </div>
      
        <div class="grid3 mt">
          <div>
            <label>Attach uploads to</label>
            <select name="attach_to" id="attachTo">
              <option value="AUTO" selected>AUTO (Latest Draft Shipment)</option>
              <option value="SHIPMENT">Choose Shipment</option>
              <option value="TICKET">Ticket-level (Shared)</option>
            </select>
            <div class="muted mt" style="font-size: 12px;">
              Tip: Use “Choose Shipment” to add missing DN/COA to an older shipment.
            </div>
          </div>
      
          <div>
            <label>Shipment (if Choose Shipment)</label>
            <select name="attach_inspection_id" id="attachInspection">
              <option value="">-- Select Shipment --</option>
              {% if inspections %}
                {% for s in inspections %}
                  {% set label = "Shipment #" ~ loop.index ~ " • " ~ (s.report_no or ("ID " ~ s.id)) %}
                  {% if s.delivery_note_no %}
                    {% set label = label ~ " • DN " ~ s.delivery_note_no %}
                  {% endif %}
                  <option value="{{ s.id }}" {% if default_insp_id and s.id == default_insp_id %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
      
          <div>
            <label>File</label>
            <input type="file" name="file" required>
          </div>
        </div>
      
        <div class="mt">
          <button class="btn btn-secondary" type="submit">Upload</button>
        </div>
      </form>
      
      <script>
(function(){
  const docType = document.getElementById("docType");
  const docNumber = document.getElementById("docNumber");
  const attachTo = document.getElementById("attachTo");
  const attachInspection = document.getElementById("attachInspection");

  function toggleDocNumberRequired() {
    const t = (docType.value || "").toUpperCase();
    const isDN = (t === "DELIVERY_NOTE");
    docNumber.required = isDN;
    docNumber.placeholder = isDN ? "Required (must match Delivery Note Number exactly)" : "Optional";
  }

  function applyAttachRules() {
    const t = (docType.value || "").toUpperCase();

    // PO must be ticket-level
    if (t === "PO") {
      attachTo.value = "TICKET";
      attachTo.disabled = true;
      attachInspection.disabled = true;
      attachInspection.value = "";
      return;
    }

    attachTo.disabled = false;

    const mode = (attachTo.value || "AUTO").toUpperCase();
    if (mode === "SHIPMENT") {
      attachInspection.disabled = false;
    } else {
      attachInspection.disabled = true;
      attachInspection.value = "";
    }
  }

  // NEW: read initial_attach_to injected by backend (Jinja)
  const initialAttachTo = "{{ (initial_attach_to or 'AUTO') }}".toUpperCase();
  if (attachTo && (initialAttachTo === "SHIPMENT" || initialAttachTo === "TICKET" || initialAttachTo === "AUTO")) {
    attachTo.value = initialAttachTo;
  }

  if (docType) {
    docType.addEventListener("change", () => {
      toggleDocNumberRequired();
      applyAttachRules();
    });
  }
  if (attachTo) attachTo.addEventListener("change", applyAttachRules);

  toggleDocNumberRequired();
  applyAttachRules();
})();
</script>
  (function(){
    const docType = document.querySelector('select[name="doc_type"]');
    const docNumber = document.querySelector('input[name="doc_number"]');
    if(!docType || !docNumber) return;

    function toggleDocNumberRequired() {
      const isDN = (docType.value || "").toUpperCase() === "DELIVERY_NOTE";
      docNumber.required = isDN;
      docNumber.placeholder = isDN
        ? "Required (must match Delivery Note Number exactly)"
        : (docNumber.placeholder || "Optional");
    }

    docType.addEventListener("change", toggleDocNumberRequired);
    toggleDocNumberRequired();
  })();
</script>
