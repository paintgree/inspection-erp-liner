{% extends "base.html" %}
{% block content %}

<a class="btn btn-ghost" href="/dashboard">← Back</a>

<div class="card">
  <div class="runheader">
    <div>
      <h1>In-Process Inspection — Runs</h1>
      <div class="muted">Grouped by Batch No for clean review.</div>
    </div>

    <div class="actions">
      <a class="btn btn-primary" href="/runs/new">+ New Production Run</a>
    </div>
  </div>

  <!-- Tabs -->
  <div class="toolbar mt" style="gap:10px;">
    <a class="btn {% if view == 'open' %}btn-primary{% else %}btn-outline-secondary{% endif %}"
       href="/runs?view=open{% if q %}&q={{ q|urlencode }}{% endif %}">
      Open Runs
    </a>

    <a class="btn {% if view == 'approved' %}btn-primary{% else %}btn-outline-secondary{% endif %}"
       href="/runs?view=approved{% if q %}&q={{ q|urlencode }}{% endif %}">
      Approved Runs
    </a>
  </div>

  <!-- Search BELOW buttons -->
  <form method="get" action="/runs" class="mt" style="display:flex; gap:10px; align-items:center;">
    <input type="hidden" name="view" value="{{ view }}">
    <input type="text"
           name="q"
           value="{{ q or '' }}"
           placeholder="Search: run #, batch, process, client, PO, ITP, spec..."
           style="max-width:620px; flex:1;">
    <button class="btn btn-primary" type="submit">Search</button>
    {% if q %}
    
    {% if q %}
      <div class="muted tiny mt">
        Showing <b>all runs</b> (Open + Approved) because search is active.
      </div>
    {% endif %}

      <a class="btn btn-outline-secondary" href="/runs?view={{ view }}">Clear</a>
    {% endif %}
  </form>

  <style>
    .batch-card { border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:14px; margin-top:14px; }
    .batch-head { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .batch-title { font-size:18px; font-weight:800; }
    .batch-sub { font-size:13px; }
    .status-pill { padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
    .st-open { background:#f3f4f6; }
    .st-approved { background:#dcfce7; }
    .st-closed { background:#fff7ed; }
    .rowpad td { padding-top:10px; padding-bottom:10px; }
  </style>

  {% if batch_cards|length == 0 %}
    <div class="muted mt">No runs found.</div>
  {% else %}

    {% for b in batch_cards %}
      <div class="batch-card">

        <div class="batch-head">
          <div>
            <div class="batch-title">Batch: {{ b.batch_no }}</div>
            <div class="batch-sub muted">
              {% if b.client_name %}Client: <b>{{ b.client_name }}</b>{% endif %}
              {% if b.po_number %} • PO: <b>{{ b.po_number }}</b>{% endif %}
            </div>
          </div>
        </div>

        <div class="tablewrap mt">
          <table class="table wide">
            <thead>
              <tr>
                <th style="width:90px;">Run ID</th>
                <th style="width:180px;">Process</th>
                <th>Client</th>
                <th style="width:160px;">PO</th>
                <th style="width:140px;">Status</th>
                <th style="width:120px;">Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for r in b.runs %}
                {% set bg = client_bg.get(r.client_name, "#f7f7f7") %}
                {% set st = (r.status or "OPEN")|upper %}
                <tr class="rowpad" style="background: {{ bg }};">
                  <td>{{ r.id }}</td>
                  <td><b>{{ r.process }}</b></td>
                  <td>{{ r.client_name or "-" }}</td>
                  <td>{{ r.po_number or "-" }}</td>

                  <td>
                    {% if st == "APPROVED" %}
                      <span class="status-pill st-approved">APPROVED</span>
                    {% elif st == "CLOSED" %}
                      <span class="status-pill st-closed">CLOSED</span>
                    {% else %}
                      <span class="status-pill st-open">OPEN</span>
                    {% endif %}
                  </td>

                  <td>
                    <a class="btn btn-sm"
                       href="/runs/{{ r.id }}?back={{ ('/runs?view=' ~ view ~ (q and ('&q=' ~ q|urlencode) or ''))|urlencode }}">
                      Open
                    </a>

                  </td>
                </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>

      </div>
    {% endfor %}

  {% endif %}

</div>

{% endblock %}
