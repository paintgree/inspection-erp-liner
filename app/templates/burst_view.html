{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <h2>Burst Report #{{ rep.id }}</h2>
  <div style="display:flex; gap:10px;">
    <a class="btn" href="/burst">Back</a>
  </div>
</div>

<div class="card">
  <div class="mini-info">
    <div><b>Run:</b> #{{ run.id }} - {{ run.process }} - {{ run.dhtp_batch_no }}</div>
    <div><b>Total Length:</b> {{ total_len }} m</div>
    <div><b>Produced Length:</b> {{ produced_len }} m</div>
  </div>

  {% set total = total_len if total_len > 0 else 1 %}
  {% set produced_pct = (produced_len / total * 100) %}
  {% set from_pct = (rep.sample_from_m / total * 100) %}
  {% set to_pct = (rep.sample_to_m / total * 100) %}
  {% set sel_w = (to_pct - from_pct) %}

  {% set total = total_len if total_len > 0 else 1 %}
  {% set from_pct = (rep.sample_from_m / total * 100) %}
  {% set to_pct = (rep.sample_to_m / total * 100) %}
  {% set sel_w = (to_pct - from_pct) %}
  
  <div class="burst-bar">
    <div class="burst-selected" style="left: {{'%.4f'|format(from_pct)}}%; width: {{'%.4f'|format(sel_w)}}%;"></div>
  </div>
  
  <div class="burst-labels">
    <span>0m</span>
    <span>{{ rep.sample_from_m }} → {{ rep.sample_to_m }} m</span>
    <span>{{ total_len }}m</span>
  </div>

  <hr/>

  <div class="grid-3">
    <div class="stat">
      <div class="k">API</div>
      <div class="v">{{ rep.api_class }}</div>
    </div>
    <div class="stat">
      <div class="k">Target</div>
      <div class="v">{{ rep.target_pressure_psi }} PSI</div>
    </div>
    <div class="stat">
      <div class="k">Actual</div>
      <div class="v">{{ rep.actual_burst_psi }} PSI</div>
    </div>
  </div>

  <div class="grid-2" style="margin-top:12px;">
    <div class="stat">
      <div class="k">Failure Mode</div>
      <div class="v">{{ rep.failure_mode }}</div>
    </div>
    <div class="stat">
      <div class="k">Temp</div>
      <div class="v">{{ rep.test_temp_c }} °C</div>
    </div>
  </div>

  {% if rep.notes %}
    <div style="margin-top:12px;">
      <div class="k"><b>Notes</b></div>
      <div>{{ rep.notes }}</div>
    </div>
  {% endif %}
</div>

<div class="card">
  <h3>Upload Photos / Burst Chart</h3>
  
  <div class="upload-grid">
  
    <!-- Chart -->
    <div class="upload-box">
      <h4>Burst Chart (PDF/Image)</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="CHART">
        <input type="hidden" name="caption" value="Burst Chart">
        <input type="file" name="file" required>
        <button class="btn primary" type="submit">Upload / Replace</button>
      </form>
    </div>
  
    <!-- Full length -->
    <div class="upload-box">
      <h4>Photo: Full Length</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="FULL">
        <input type="hidden" name="caption" value="Full Length">
        <input type="file" name="file" required>
        <button class="btn primary" type="submit">Upload / Replace</button>
      </form>
    </div>
  
    <!-- Side A -->
    <div class="upload-box">
      <h4>Photo: Side A (Left)</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="SIDE_A">
        <input type="hidden" name="caption" value="Side A (Left)">
        <input type="file" name="file" required>
        <button class="btn primary" type="submit">Upload / Replace</button>
      </form>
    </div>
  
    <!-- Side B -->
    <div class="upload-box">
      <h4>Photo: Side B (Right)</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="SIDE_B">
        <input type="hidden" name="caption" value="Side B (Right)">
        <input type="file" name="file" required>
        <button class="btn primary" type="submit">Upload / Replace</button>
      </form>
    </div>
  
  </div>

  <hr/>

  <h3>Attachments</h3>
  {% if attachments %}
    {% set slot_map = {} %}
    {% for a in attachments %}
      {% set _ = slot_map.update({a.kind: a}) %}
    {% endfor %}
    
    <ul>
      {% for k in ["CHART","FULL","SIDE_A","SIDE_B"] %}
        <li>
          <b>{{k}}</b> —
          {% if slot_map.get(k) %}
            <a href="/burst/files/{{slot_map.get(k).id}}/view" target="_blank">Open</a>
            <small>({{slot_map.get(k).caption}})</small>
          {% else %}
            <span style="opacity:0.6;">Not uploaded</span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No attachments yet.</p>
  {% endif %}
</div>

{% endblock %}
