{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <h2>Short-Time Hydrostatic Burst Pressure Test</h2>
  <a class="btn" href="/burst">Back</a>
</div>

<div class="card">
  <div class="mini-info">
    <div><b>Batch:</b> {{ rep.batch_no }}</div>
    <div><b>Total Length:</b> {{ rep.total_length_m }} m</div>
    <div><b>Sample:</b> {{ rep.sample_start_m }} → {{ rep.sample_start_m + rep.sample_length_m }} m</div>
    <div><b>Mode:</b> {% if rep.is_unlinked %}Manual{% else %}Linked{% endif %}</div>
  </div>

  {% set total = rep.total_length_m if rep.total_length_m > 0 else 1 %}
  {% set from_pct = (rep.sample_start_m / total * 100) %}
  {% set to_pct = ((rep.sample_start_m + rep.sample_length_m) / total * 100) %}
  {% set sel_w = (to_pct - from_pct) %}

  {% set total = live.total_length_m if live.total_length_m > 0 else 1 %}
  
  <!-- =========================
       ENGINEERING PIPE VISUAL (Option B: multi zoom insets)
       ========================= -->
  
  <div class="eng-viz card">
    <div class="eng-viz-head">
      <div class="eng-viz-title">PIPE LOCATION (Engineering Scale)</div>
      <div class="eng-viz-meta">
        <span><b>Total:</b> {{ "%.1f"|format(live.total_length_m or rep.total_length_m or 0) }} m</span>
        <span class="muted">•</span>
        <span class="muted">Samples shown as dimension brackets (stacked)</span>
      </div>
    </div>
  
    <!-- Hidden sample dataset for JS (no tojson dependency) -->
    <div id="engSamples" style="display:none;">
      {# Always include the main (USED) sample from the report itself #}
      {% if rep.sample_length_m and rep.sample_length_m > 0 %}
        <div class="srow"
             data-start="{{ rep.sample_start_m }}"
             data-len="{{ rep.sample_length_m }}"
             data-serial="{{ rep.sample_serial_number or 'USED' }}">
        </div>
      {% endif %}
    
      {# Also include any extra samples stored in the samples table #}
      {% for s in samples %}
        {% if s.sample_length_m and s.sample_length_m > 0 %}
          <div class="srow"
               data-start="{{ s.sample_start_m }}"
               data-len="{{ s.sample_length_m }}"
               data-serial="{{ s.sample_serial_number or '' }}">
          </div>
        {% endif %}
      {% endfor %}
    </div>
  
    <div id="engPipeViz"
         class="eng-viz-body"
         data-total="{{ live.total_length_m or rep.total_length_m or 0 }}">
      <!-- JS will render SVG here -->
    </div>
  
    <div class="eng-viz-insets">
      <div class="eng-viz-insets-title">AUTO ZOOM WINDOWS (Clusters)</div>
      <div id="engPipeInsets"></div>
    </div>
  </div>
  
  <script>
(function () {
  const root = document.getElementById("engPipeViz");
  const insetRoot = document.getElementById("engPipeInsets");

  // If the container is missing, don't crash the page.
  if (!root || !insetRoot) return;

  function safeText(msg) {
    root.innerHTML = `<div class="muted" style="padding:10px;">${msg}</div>`;
  }

  try {
    const total = parseFloat(root.dataset.total || "0") || 1;

    // Read samples from hidden rows
    const sampleRows = Array.from(document.querySelectorAll("#engSamples .srow"));
    const samples = sampleRows
      .map((el, i) => {
        const start = parseFloat(el.dataset.start || "0") || 0;
        const len = parseFloat(el.dataset.len || "0") || 0;
        const serial = (el.dataset.serial || "").trim();
        return {
          idx: i + 1,
          label: serial ? serial : ("S" + (i + 1)),
          start,
          end: start + len,
          len
        };
      })
      .filter(s => s.len > 0);

    // ---------- helpers ----------
    function niceStep(range, targetTicks) {
      const r = Math.max(1e-9, range);
      const rough = r / Math.max(1, targetTicks);
      const pow = Math.pow(10, Math.floor(Math.log10(rough)));
      const n = rough / pow;
      let mult = 1;
      if (n >= 5) mult = 5;
      else if (n >= 2) mult = 2;
      else mult = 1;
      return mult * pow;
    }

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function svgEl(tag) {
      return document.createElementNS("http://www.w3.org/2000/svg", tag);
    }

    function fmt(v) {
      return (Math.round(v * 10) / 10).toFixed(1);
    }

    function buildMainScale() {
      const W = Math.max(920, root.clientWidth || 920);
      const H = 180;

      const padL = 56, padR = 18;
      const x0 = padL, x1 = W - padR;
      const scaleW = x1 - x0;

      const yBase = 110;
      const yTicksTop = 96;

      const svg = svgEl("svg");
      svg.setAttribute("width", "100%");
      svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
      svg.classList.add("eng-svg");

      // background
      const bg = svgEl("rect");
      bg.setAttribute("x", "0"); bg.setAttribute("y", "0");
      bg.setAttribute("width", W); bg.setAttribute("height", H);
      bg.setAttribute("class", "eng-bg");
      svg.appendChild(bg);

      // base rail
      const rail = svgEl("rect");
      rail.setAttribute("x", x0);
      rail.setAttribute("y", yBase);
      rail.setAttribute("width", scaleW);
      rail.setAttribute("height", 14);
      rail.setAttribute("rx", 7);
      rail.setAttribute("class", "eng-rail");
      svg.appendChild(rail);

      // ticks
      const major = niceStep(total, 10);
      const minor = major / 5;

      for (let v = 0; v <= total + 1e-9; v += minor) {
        const isMajor = Math.abs((v / major) - Math.round(v / major)) < 1e-6;
        const x = x0 + (v / total) * scaleW;

        const tick = svgEl("line");
        tick.setAttribute("x1", x); tick.setAttribute("x2", x);
        tick.setAttribute("y1", yBase);
        tick.setAttribute("y2", isMajor ? yTicksTop : (yBase + 2));
        tick.setAttribute("class", isMajor ? "eng-tick-major" : "eng-tick-minor");
        svg.appendChild(tick);

        if (isMajor) {
          const t = svgEl("text");
          t.setAttribute("x", x);
          t.setAttribute("y", yTicksTop - 8);
          t.setAttribute("text-anchor", "middle");
          t.setAttribute("class", "eng-label");
          t.textContent = Math.round(v) + "m";
          svg.appendChild(t);
        }
      }

      // endpoints labels
      const left = svgEl("text");
      left.setAttribute("x", x0);
      left.setAttribute("y", yBase + 40);
      left.setAttribute("text-anchor", "start");
      left.setAttribute("class", "eng-end");
      left.textContent = "0m";
      svg.appendChild(left);

      const right = svgEl("text");
      right.setAttribute("x", x1);
      right.setAttribute("y", yBase + 40);
      right.setAttribute("text-anchor", "end");
      right.setAttribute("class", "eng-end");
      right.textContent = fmt(total) + "m";
      svg.appendChild(right);

      // stacked dimension brackets
      const intervals = samples
        .map(s => {
          const xa = x0 + (s.start / total) * scaleW;
          const xb = x0 + (s.end / total) * scaleW;
          return { ...s, xa, xb };
        })
        .sort((a, b) => a.xa - b.xa);

      const rowEnds = []; // last xb per row
      function placeRow(seg) {
        for (let r = 0; r < rowEnds.length; r++) {
          if (seg.xa > rowEnds[r] + 14) {
            rowEnds[r] = seg.xb;
            return r;
          }
        }
        rowEnds.push(seg.xb);
        return rowEnds.length - 1;
      }

      const yTop = 34;
      const rowH = 22;

      intervals.forEach(seg => {
        const r = placeRow(seg);
        const y = yTop + r * rowH;

        // bracket line
        const line = svgEl("line");
        line.setAttribute("x1", seg.xa);
        line.setAttribute("x2", seg.xb);
        line.setAttribute("y1", y);
        line.setAttribute("y2", y);
        line.setAttribute("class", "eng-bracket");
        svg.appendChild(line);

        // bracket ends
        const l1 = svgEl("line");
        l1.setAttribute("x1", seg.xa); l1.setAttribute("x2", seg.xa);
        l1.setAttribute("y1", y - 6); l1.setAttribute("y2", y + 6);
        l1.setAttribute("class", "eng-bracket-end");
        svg.appendChild(l1);

        const l2 = svgEl("line");
        l2.setAttribute("x1", seg.xb); l2.setAttribute("x2", seg.xb);
        l2.setAttribute("y1", y - 6); l2.setAttribute("y2", y + 6);
        l2.setAttribute("class", "eng-bracket-end");
        svg.appendChild(l2);

        // drop lines
        const d1 = svgEl("line");
        d1.setAttribute("x1", seg.xa); d1.setAttribute("x2", seg.xa);
        d1.setAttribute("y1", y + 6); d1.setAttribute("y2", yBase);
        d1.setAttribute("class", "eng-drop");
        svg.appendChild(d1);

        const d2 = svgEl("line");
        d2.setAttribute("x1", seg.xb); d2.setAttribute("x2", seg.xb);
        d2.setAttribute("y1", y + 6); d2.setAttribute("y2", yBase);
        d2.setAttribute("class", "eng-drop");
        svg.appendChild(d2);

        // label
        const mid = (seg.xa + seg.xb) / 2;
        const txt = svgEl("text");
        txt.setAttribute("x", mid);
        txt.setAttribute("y", y - 10);
        txt.setAttribute("text-anchor", "middle");
        txt.setAttribute("class", "eng-sample-label");
        txt.textContent = `${seg.label}  ${fmt(seg.start)}–${fmt(seg.end)}  (${fmt(seg.len)}m)`;
        svg.appendChild(txt);

        // ===== Visible locator on rail (always readable even for tiny samples) =====
        const block = svgEl("rect");
        const minPx = 12;
        const rawW = (seg.xb - seg.xa);
        const w = Math.max(minPx, rawW);
        const x = rawW < minPx ? ((seg.xa + seg.xb) / 2 - (minPx / 2)) : seg.xa;

        block.setAttribute("x", x);
        block.setAttribute("y", yBase - 1);
        block.setAttribute("width", w);
        block.setAttribute("height", 16);
        block.setAttribute("rx", 8);
        block.setAttribute("class", "eng-rail-cut eng-rail-cut-strong");
        svg.appendChild(block);

        // Start/End pins
        function pin(px, label) {
          const c = svgEl("circle");
          c.setAttribute("cx", px);
          c.setAttribute("cy", yBase + 7);
          c.setAttribute("r", 6);
          c.setAttribute("class", "eng-pin");
          svg.appendChild(c);

          const t = svgEl("text");
          t.setAttribute("x", px);
          t.setAttribute("y", yBase + 30);
          t.setAttribute("text-anchor", "middle");
          t.setAttribute("class", "eng-pin-label");
          t.textContent = label;
          svg.appendChild(t);
        }
        pin(seg.xa, "START");
        pin(seg.xb, "END");
      });

      root.innerHTML = "";
      root.appendChild(svg);
    }

    function buildZoomInsets() {
      insetRoot.innerHTML = "";
      if (samples.length === 0) return;

      const padMin = 20;
      const padPct = 0.01 * total;

      const windows = samples
        .map(s => {
          const pad = Math.max(padMin, padPct, s.len * 10);
          return { a: clamp(s.start - pad, 0, total), b: clamp(s.end + pad, 0, total) };
        })
        .sort((x, y) => x.a - y.a);

      const merged = [];
      for (const w of windows) {
        if (merged.length === 0) merged.push({ ...w });
        else {
          const last = merged[merged.length - 1];
          if (w.a <= last.b) last.b = Math.max(last.b, w.b);
          else merged.push({ ...w });
        }
      }

      merged.forEach((win, idx) => {
        const W = Math.max(920, root.clientWidth || 920);
        const H = 96;

        const padL = 56, padR = 18;
        const x0 = padL, x1 = W - padR;
        const scaleW = x1 - x0;

        const range = Math.max(1e-9, win.b - win.a);

        const svg = svgEl("svg");
        svg.setAttribute("width", "100%");
        svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
        svg.classList.add("eng-svg-inset");

        const bg = svgEl("rect");
        bg.setAttribute("x", "0"); bg.setAttribute("y", "0");
        bg.setAttribute("width", W); bg.setAttribute("height", H);
        bg.setAttribute("class", "eng-bg-inset");
        svg.appendChild(bg);

        const title = svgEl("text");
        title.setAttribute("x", x0);
        title.setAttribute("y", 18);
        title.setAttribute("text-anchor", "start");
        title.setAttribute("class", "eng-inset-title");
        title.textContent = `Zoom ${idx + 1}: ${fmt(win.a)}m → ${fmt(win.b)}m`;
        svg.appendChild(title);

        const yBase = 52;

        const rail = svgEl("rect");
        rail.setAttribute("x", x0);
        rail.setAttribute("y", yBase);
        rail.setAttribute("width", scaleW);
        rail.setAttribute("height", 14);
        rail.setAttribute("rx", 7);
        rail.setAttribute("class", "eng-rail-inset");
        svg.appendChild(rail);

        const major = niceStep(range, 8);
        const minor = major / 5;

        for (let v = Math.ceil(win.a / minor) * minor; v <= win.b + 1e-9; v += minor) {
          const isMajor = Math.abs((v / major) - Math.round(v / major)) < 1e-6;
          const x = x0 + ((v - win.a) / range) * scaleW;

          const tick = svgEl("line");
          tick.setAttribute("x1", x); tick.setAttribute("x2", x);
          tick.setAttribute("y1", yBase);
          tick.setAttribute("y2", isMajor ? (yBase - 12) : (yBase + 2));
          tick.setAttribute("class", isMajor ? "eng-tick-major" : "eng-tick-minor");
          svg.appendChild(tick);

          if (isMajor) {
            const t = svgEl("text");
            t.setAttribute("x", x);
            t.setAttribute("y", yBase - 18);
            t.setAttribute("text-anchor", "middle");
            t.setAttribute("class", "eng-label");
            t.textContent = Math.round(v) + "m";
            svg.appendChild(t);
          }
        }

        samples.forEach(s => {
          if (s.end < win.a || s.start > win.b) return;

          const xa = x0 + ((clamp(s.start, win.a, win.b) - win.a) / range) * scaleW;
          const xb = x0 + ((clamp(s.end, win.a, win.b) - win.a) / range) * scaleW;

          const block = svgEl("rect");
          block.setAttribute("x", xa);
          block.setAttribute("y", yBase);
          block.setAttribute("width", Math.max(14, xb - xa));
          block.setAttribute("height", 14);
          block.setAttribute("rx", 7);
          block.setAttribute("class", "eng-rail-cut eng-rail-cut-strong");
          svg.appendChild(block);

          const lbl = svgEl("text");
          lbl.setAttribute("x", (xa + xb) / 2);
          lbl.setAttribute("y", yBase + 34);
          lbl.setAttribute("text-anchor", "middle");
          lbl.setAttribute("class", "eng-inset-sample");
          lbl.textContent = `${s.label} ${fmt(s.start)}–${fmt(s.end)} (${fmt(s.len)}m)`;
          svg.appendChild(lbl);
        });

        const wrap = document.createElement("div");
        wrap.className = "eng-inset-wrap";
        wrap.appendChild(svg);
        insetRoot.appendChild(wrap);
      });
    }

    // Render main scale always
    buildMainScale();

    // Render insets but NEVER allow it to kill the main scale
    try {
      buildZoomInsets();
    } catch (e) {
      console.error("Zoom inset render failed:", e);
    }

    // Re-render on resize
    let t = null;
    window.addEventListener("resize", () => {
      clearTimeout(t);
      t = setTimeout(() => {
        try { buildMainScale(); } catch (e) { console.error(e); }
        try { buildZoomInsets(); } catch (e) { console.error(e); }
      }, 120);
    });

  } catch (e) {
    console.error("Engineering scale render failed:", e);
    safeText("Scale failed to render (check browser console).");
  }
})();
</script>

  {% if rep.is_locked %}
    <div class="locked-banner">
      ✅ Report is locked (saved). To edit, reopen with reason.
    </div>
  
    <form method="post" action="/burst/{{rep.id}}/reopen" class="reopen-box">
      <input name="reason" placeholder="Reason for reopening (required for audit)" required>
      <button class="btn btn-primary" type="submit">Reopen for Edit</button>
    </form>
  {% else %}
    <div class="card">
      <h3>Add another sample</h3>
      <form method="post" action="/burst/{{rep.id}}/samples/add" class="grid-2">
        <div>
          <label>Sample Start (m)</label>
          <input name="sample_start_m" type="number" step="0.1" required>
        </div>
        <div>
          <label>Sample Length (m)</label>
          <input name="sample_length_m" type="number" step="0.1" required>
        </div>
        <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end;">
          <button class="btn btn-primary" type="submit">+ Add Sample</button>
        </div>
      </form>
    </div>
  {% endif %}

  <div class="burst-labels">
    <span>0m</span>
    <span>{{ rep.sample_start_m }} → {{ rep.sample_start_m + rep.sample_length_m }} m (Used)</span>
    <span>{{ rep.total_length_m }}m</span>
  </div>
</div>

<form method="post" action="/burst/{{rep.id}}/update">
  <div class="card">
    <h3>TEST DETAILS</h3>

    <div class="grid-2">
      <div>
        <label>Client Name</label>
        <input value="{{ live.client_name }}" readonly>
      </div>
      <div>
        <label>Client PO#</label>
        <input value="{{ live.client_po }}" readonly>
      </div>

      <div>
        <label>Specimen Specification</label>
        <input value="{{ live.pipe_specification }}" readonly>
      </div>
      <div>
        <label>DHTP Batch Number Ref</label>
        <input value="{{ live.liner_material_grade }}" readonly>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Reference Standard</label>
        <input name="reference_standard" value="{{ rep.reference_standard }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Reference DHTP Procedure</label>
        <input name="reference_dhtp_procedure" value="{{ rep.reference_dhtp_procedure }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>

      <div>
        <label>System Maximum Pressure</label>
        <input name="system_max_pressure" value="{{ rep.system_max_pressure }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Laboratory Temperature</label>
        <input name="laboratory_temperature" value="{{ rep.laboratory_temperature }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>

      <div>
        <label>Testing Medium</label>
        <input name="testing_medium" value="{{ rep.testing_medium }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Total No. of Specimens</label>
          <select name="total_no_of_specimens" {% if rep.is_locked %}disabled{% endif %}>
            <option value="1" {% if (rep.total_no_of_specimens or 1) == 1 %}selected{% endif %}>1</option>
            <option value="2" {% if rep.total_no_of_specimens == 2 %}selected{% endif %}>2</option>
            <option value="5" {% if rep.total_no_of_specimens == 5 %}selected{% endif %}>5</option>
          </select>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>SPECIMENS DETAILS</h3>

    <div class="grid-2">
      <div>
        <label>Specimen Ref # (Start length)</label>
        <input value="{{ rep.sample_start_m }} m" readonly>
      </div>
      <div>
        <label>Total Length of Specimen</label>
        <input value="{{ rep.sample_length_m }} m" readonly>
      </div>

      <div>
        <label>Effective Length of Specimen</label>
        <input name="effective_length_m" value="{{ rep.effective_length_m }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div></div>
    </div>

    <div class="grid-2">
      <div>
        <label>Liner Material (grade)</label>
        <input value="{{ rep.liner_material_grade }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Liner Wall Thickness</label>
        <input name="liner_thickness" value="{{ rep.liner_thickness }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>

      <div>
        <label>Reinforcement Material (grade)</label>
        <input value="{{ rep.reinforcement_material_grade }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Reinforcement Wall Thickness</label>
        <input name="reinforcement_thickness" value="{{ rep.reinforcement_thickness }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>

      <div>
        <label>Cover Material (grade)</label>
        <input value="{{ rep.cover_material_grade }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Cover Wall Thickness</label>
        <input name="cover_thickness" value="{{ rep.cover_thickness }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>TEST RESULTS</h3>

    <div class="grid-2">
      <div>
        <label>Sample Serial Number</label>
        <input name="sample_serial_number" value="{{ rep.sample_serial_number }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Actual Burst Pressure (PSI)</label>
        <input name="actual_burst_psi" type="number" step="0.1" value="{{ rep.actual_burst_psi }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>

      <div>
        <label>Pressurization Time (Sec)</label>
        <input name="pressurization_time_s" value="{{ rep.pressurization_time_s }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Result</label>
        <select name="test_result">
          <option value="" {% if rep.test_result=="" %}selected{% endif %}></option>
          <option value="PASS" {% if rep.test_result=="PASS" %}selected{% endif %}>PASS</option>
          <option value="FAIL" {% if rep.test_result=="FAIL" %}selected{% endif %}>FAIL</option>
        </select>
      </div>

      <div>
        <label>Failure Mode</label>
        <input name="failure_mode" value="{{ rep.failure_mode }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div></div>
    </div>

    <label>Notes</label>
    <textarea name="notes" rows="3">{{ rep.notes }}</textarea>

    <div class="toolbar mt">
      <button class="btn btn-primary" type="submit">Save</button>
    </div>

    {% if not rep.is_locked %}
      <button class="btn btn-primary" type="submit">Save & Lock</button>
    {% endif %}
  </div>

  <div class="card">
    <h3>Approval & Signature</h3>
    <div class="grid-2">
      <div>
        <label>QA/QC Officer</label>
        <input name="qa_qc_officer_name" value="{{ rep.qa_qc_officer_name }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
      <div>
        <label>Testing Operator</label>
        <input name="testing_operator_name" value="{{ rep.testing_operator_name }}" {% if rep.is_locked %}disabled{% endif %}>
      </div>
    </div>
  </div>
</form>

<div class="card">

  <div class="card">
    <h3>Upload files for which sample?</h3>
    <select id="uploadSampleId">
      <option value="">Main / Default</option>
      {% for s in samples %}
        <option value="{{ s.id }}">{{ s.sample_serial_number or ("Sample #" ~ loop.index) }}</option>
      {% endfor %}
    </select>
    <small class="muted">Choose sample, then upload chart/photos. (For multi-sample reports, pick each sample and upload its 4 files.)</small>
  </div>
  
  <script>
    // When you submit upload forms, inject selected sample_id
    document.addEventListener("submit", function(e){
      const form = e.target;
      if (!form || !form.action || !form.action.includes("/burst/")) return;
      if (form.querySelector('input[name="file"]')) {
        const sel = document.getElementById("uploadSampleId");
        if (sel) {
          let hid = form.querySelector('input[name="sample_id"]');
          if (!hid) {
            hid = document.createElement("input");
            hid.type = "hidden";
            hid.name = "sample_id";
            form.appendChild(hid);
          }
          hid.value = sel.value || "";
        }
      }
    }, true);
  </script>
  <h3>Test Curve & Photos (After Burst)</h3>

  <div class="upload-grid">
    <div class="upload-box">
      <h4>Burst Chart (PDF/Image)</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="CHART" {% if rep.is_locked %}disabled{% endif %}>
        <input type="hidden" name="caption" value="Burst Chart" {% if rep.is_locked %}disabled{% endif %}>
        <input type="file" name="file" required>
        <button class="btn btn-primary" type="submit">Upload / Replace</button>
      </form>
    </div>

    <div class="upload-box">
      <h4>FULL LENGTH</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="FULL" {% if rep.is_locked %}disabled{% endif %}>
        <input type="hidden" name="caption" value="Full Length" {% if rep.is_locked %}disabled{% endif %}>
        <input type="file" name="file" required>
        <button class="btn btn-primary" type="submit">Upload / Replace</button>
      </form>
    </div>

    <div class="upload-box">
      <h4>SIDE A</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="SIDE_A" {% if rep.is_locked %}disabled{% endif %}>
        <input type="hidden" name="caption" value="Side A" {% if rep.is_locked %}disabled{% endif %}>
        <input type="file" name="file" required>
        <button class="btn btn-primary" type="submit">Upload / Replace</button>
      </form>
    </div>

    <div class="upload-box">
      <h4>SIDE B</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="SIDE_B" {% if rep.is_locked %}disabled{% endif %}>
        <input type="hidden" name="caption" value="Side B" {% if rep.is_locked %}disabled{% endif %}>
        <input type="file" name="file" required>
        <button class="btn btn-primary" type="submit">Upload / Replace</button>
      </form>
    </div>
  </div>

  <hr/>

  {% set slot_map = {} %}
  {% for a in attachments %}
    {% set _ = slot_map.update({a.kind: a}) %}
  {% endfor %}

  <ul>
    {% for k in ["CHART","FULL","SIDE_A","SIDE_B"] %}
      <li>
        <b>{{k}}</b> —
        {% if slot_map.get(k) %}
          <a href="/burst/files/{{slot_map.get(k).id}}/view" target="_blank">Open</a>
          <small class="muted">({{slot_map.get(k).caption}})</small>
        {% else %}
          <span class="muted">Not uploaded</span>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
</div>

{% endblock %}
