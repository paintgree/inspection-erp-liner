{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <h2>Short-Time Hydrostatic Burst Pressure Test</h2>
  <a class="btn" href="/burst">Back</a>
</div>

<div class="card">
  <div class="mini-info">
    <div><b>Batch:</b> {{ rep.batch_no }}</div>
    <div><b>Total Length:</b> {{ rep.total_length_m }} m</div>
    <div><b>Sample:</b> {{ rep.sample_start_m }} → {{ rep.sample_start_m + rep.sample_length_m }} m</div>
    <div><b>Mode:</b> {% if rep.is_unlinked %}Manual{% else %}Linked{% endif %}</div>
  </div>

  {% set total = rep.total_length_m if rep.total_length_m > 0 else 1 %}
  {% set from_pct = (rep.sample_start_m / total * 100) %}
  {% set to_pct = ((rep.sample_start_m + rep.sample_length_m) / total * 100) %}
  {% set sel_w = (to_pct - from_pct) %}

  <div class="burst-bar">
    <div class="burst-selected" style="left: {{'%.4f'|format(from_pct)}}%; width: {{'%.4f'|format(sel_w)}}%;"></div>
  </div>

  <div class="burst-labels">
    <span>0m</span>
    <span>{{ rep.sample_start_m }} → {{ rep.sample_start_m + rep.sample_length_m }} m (Used)</span>
    <span>{{ rep.total_length_m }}m</span>
  </div>
</div>

<form method="post" action="/burst/{{rep.id}}/update">
  <div class="card">
    <h3>TEST DETAILS</h3>

    <div class="grid-2">
      <div>
        <label>Client Name</label>
        <input value="{{ rep.client_name }}" readonly>
      </div>
      <div>
        <label>Client PO#</label>
        <input value="{{ rep.client_po }}" readonly>
      </div>

      <div>
        <label>Specimen Specification</label>
        <input value="{{ rep.pipe_specification }}" readonly>
      </div>
      <div>
        <label>DHTP Batch Number Ref</label>
        <input value="{{ rep.batch_no }}" readonly>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Reference Standard</label>
        <input name="reference_standard" value="{{ rep.reference_standard }}">
      </div>
      <div>
        <label>Reference DHTP Procedure</label>
        <input name="reference_dhtp_procedure" value="{{ rep.reference_dhtp_procedure }}">
      </div>

      <div>
        <label>System Maximum Pressure</label>
        <input name="system_max_pressure" value="{{ rep.system_max_pressure }}">
      </div>
      <div>
        <label>Laboratory Temperature</label>
        <input name="laboratory_temperature" value="{{ rep.laboratory_temperature }}">
      </div>

      <div>
        <label>Testing Medium</label>
        <input name="testing_medium" value="{{ rep.testing_medium }}">
      </div>
      <div>
        <label>Total No. of Specimens</label>
        <input name="total_no_of_specimens" type="number" value="{{ rep.total_no_of_specimens }}">
      </div>
    </div>
  </div>

  <div class="card">
    <h3>SPECIMENS DETAILS</h3>

    <div class="grid-2">
      <div>
        <label>Specimen Ref # (Start length)</label>
        <input value="{{ rep.sample_start_m }} m" readonly>
      </div>
      <div>
        <label>Total Length of Specimen</label>
        <input value="{{ rep.sample_length_m }} m" readonly>
      </div>

      <div>
        <label>Effective Length of Specimen</label>
        <input name="effective_length_m" value="{{ rep.effective_length_m }}" placeholder="Example: 700mm">
      </div>
      <div></div>
    </div>

    <div class="grid-2">
      <div>
        <label>Liner Material (grade)</label>
        <input value="{{ rep.liner_material_grade }}" readonly>
      </div>
      <div>
        <label>Liner Wall Thickness</label>
        <input name="liner_thickness" value="{{ rep.liner_thickness }}">
      </div>

      <div>
        <label>Reinforcement Material (grade)</label>
        <input value="{{ rep.reinforcement_material_grade }}" readonly>
      </div>
      <div>
        <label>Reinforcement Wall Thickness</label>
        <input name="reinforcement_thickness" value="{{ rep.reinforcement_thickness }}">
      </div>

      <div>
        <label>Cover Material (grade)</label>
        <input value="{{ rep.cover_material_grade }}" readonly>
      </div>
      <div>
        <label>Cover Wall Thickness</label>
        <input name="cover_thickness" value="{{ rep.cover_thickness }}">
      </div>
    </div>
  </div>

  <div class="card">
    <h3>TEST RESULTS</h3>

    <div class="grid-2">
      <div>
        <label>Sample Serial Number</label>
        <input name="sample_serial_number" value="{{ rep.sample_serial_number }}">
      </div>
      <div>
        <label>Actual Burst Pressure (PSI)</label>
        <input name="actual_burst_psi" type="number" step="0.1" value="{{ rep.actual_burst_psi }}">
      </div>

      <div>
        <label>Pressurization Time (Sec)</label>
        <input name="pressurization_time_s" value="{{ rep.pressurization_time_s }}">
      </div>
      <div>
        <label>Result</label>
        <select name="test_result">
          <option value="" {% if rep.test_result=="" %}selected{% endif %}></option>
          <option value="PASS" {% if rep.test_result=="PASS" %}selected{% endif %}>PASS</option>
          <option value="FAIL" {% if rep.test_result=="FAIL" %}selected{% endif %}>FAIL</option>
        </select>
      </div>

      <div>
        <label>Failure Mode</label>
        <input name="failure_mode" value="{{ rep.failure_mode }}">
      </div>
      <div></div>
    </div>

    <label>Notes</label>
    <textarea name="notes" rows="3">{{ rep.notes }}</textarea>

    <div class="toolbar mt">
      <button class="btn btn-primary" type="submit">Save</button>
    </div>
  </div>

  <div class="card">
    <h3>Approval & Signature</h3>
    <div class="grid-2">
      <div>
        <label>QA/QC Officer</label>
        <input name="qa_qc_officer_name" value="{{ rep.qa_qc_officer_name }}">
      </div>
      <div>
        <label>Testing Operator</label>
        <input name="testing_operator_name" value="{{ rep.testing_operator_name }}">
      </div>
    </div>
  </div>
</form>

<div class="card">
  <h3>Test Curve & Photos (After Burst)</h3>

  <div class="upload-grid">
    <div class="upload-box">
      <h4>Burst Chart (PDF/Image)</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="CHART">
        <input type="hidden" name="caption" value="Burst Chart">
        <input type="file" name="file" required>
        <button class="btn btn-primary" type="submit">Upload / Replace</button>
      </form>
    </div>

    <div class="upload-box">
      <h4>FULL LENGTH</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="FULL">
        <input type="hidden" name="caption" value="Full Length">
        <input type="file" name="file" required>
        <button class="btn btn-primary" type="submit">Upload / Replace</button>
      </form>
    </div>

    <div class="upload-box">
      <h4>SIDE A</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="SIDE_A">
        <input type="hidden" name="caption" value="Side A">
        <input type="file" name="file" required>
        <button class="btn btn-primary" type="submit">Upload / Replace</button>
      </form>
    </div>

    <div class="upload-box">
      <h4>SIDE B</h4>
      <form method="post" action="/burst/{{rep.id}}/upload" enctype="multipart/form-data">
        <input type="hidden" name="kind" value="SIDE_B">
        <input type="hidden" name="caption" value="Side B">
        <input type="file" name="file" required>
        <button class="btn btn-primary" type="submit">Upload / Replace</button>
      </form>
    </div>
  </div>

  <hr/>

  {% set slot_map = {} %}
  {% for a in attachments %}
    {% set _ = slot_map.update({a.kind: a}) %}
  {% endfor %}

  <ul>
    {% for k in ["CHART","FULL","SIDE_A","SIDE_B"] %}
      <li>
        <b>{{k}}</b> —
        {% if slot_map.get(k) %}
          <a href="/burst/files/{{slot_map.get(k).id}}/view" target="_blank">Open</a>
          <small class="muted">({{slot_map.get(k).caption}})</small>
        {% else %}
          <span class="muted">Not uploaded</span>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
</div>

{% endblock %}
