{% extends "base.html" %}
{% block content %}
{# Safety: if backend forgets form_data, page still works #}
{% set form_data = form_data if form_data is defined and form_data else {} %}

<div class="card">
  <h1>Outsourced Material Receiving Inspection</h1>

  <form method="post" action="/mrr/{{ lot.id }}/inspection/{{ inspection.id }}/submit" class="form mt">

  <a class="btn btn-muted" href="/mrr/{{ lot.id }}/docs?attach_to=SHIPMENT&attach_inspection_id={{ inspection.id }}">
    Uploads / Documentation
  </a>

    <!-- HEADER -->
    <div class="grid-2">
      <div>
        <label>Report Number</label>
        <input name="report_no" value="{{ inspection.report_no }}" readonly>
      </div>

      <div>
        <label>Date</label>
        <input name="report_date" value="{{ inspection.created_at.strftime('%Y-%m-%d') if inspection.created_at else '' }}" readonly>
      </div>

      <div>
        <label>Delivery Note</label>
        <input name="delivery_note_no" value="{{ inspection.delivery_note_no or '' }}" required>
      </div>

      <div>
        <label>Purchase Order</label>
        <input name="purchase_order" value="{{ lot.po_number or '' }}" readonly>
      </div>
    </div>

    <!-- ITEMS TABLE -->
    <h3 class="mt">Items</h3>
    <p class="muted">Fill as per QAP0600-F02 table.</p>

    <table class="table" id="itemsTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>P.O Description</th>
          <th>Size</th>
          <th>Type</th>
          <th>Pressure Rating / Class</th>
          <th>Qty</th>
          <th>MTC Certificate No.</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        {% set items_item = form_data.get('items_item[]', []) %}
        {% set items_desc = form_data.get('items_desc[]', []) %}
        {% set items_size = form_data.get('items_size[]', []) %}
        {% set items_type = form_data.get('items_type[]', []) %}
        {% set items_pressure = form_data.get('items_pressure[]', []) %}
        {% set items_qty = form_data.get('items_qty[]', []) %}
        {% set items_mtc = form_data.get('items_mtc[]', []) %}

        {% set max_len = [items_item|length, items_desc|length, items_size|length, items_type|length, items_pressure|length, items_qty|length, items_mtc|length] | max %}
        {% if max_len < 1 %}{% set max_len = 1 %}{% endif %}

        {% for i in range(max_len) %}
        <tr data-template="1">
          <td><input name="items_item[]" value="{{ items_item[i] if i < items_item|length else '' }}"></td>
          <td><input name="items_desc[]" value="{{ items_desc[i] if i < items_desc|length else '' }}"></td>
          <td><input name="items_size[]" value="{{ items_size[i] if i < items_size|length else '' }}"></td>
          <td><input name="items_type[]" value="{{ items_type[i] if i < items_type|length else '' }}"></td>
          <td><input name="items_pressure[]" value="{{ items_pressure[i] if i < items_pressure|length else '' }}"></td>
          <td><input name="items_qty[]" value="{{ items_qty[i] if i < items_qty|length else '' }}"></td>
          <td><input name="items_mtc[]" value="{{ items_mtc[i] if i < items_mtc|length else '' }}"></td>
          <td><button type="button" class="btn btn-muted" onclick="removeRow(this)">X</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="button" class="btn btn-muted" onclick="addItemRow()">+ Add Row</button>

    <!-- VISUAL INSPECTION -->
    <h3 class="mt">Visual Inspection (10% Sampling)</h3>

    <div class="mt">
      <button type="button" class="btn btn-muted" onclick="copyHeatToAll()">Copy Heat No. to all rows</button>
    </div>

    <table class="table" id="visualTable">
      <thead>
        <tr>
          <th>Heat No</th>
          <th>Flange ID / S.N</th>
          <th>Surface Condition</th>
          <th>Physical Damage</th>
          <th>Package Condition</th>
          <th>Markings & Labeling</th>
          <th>Result (ACC/REJ)</th>
          <th></th>
        </tr>
      </thead>
    
      <tbody>
        {% set vis_batch = form_data.get('vis_batch[]', []) %}
        {% set vis_flange = form_data.get('vis_flange[]', []) %}
        {% set vis_surface = form_data.get('vis_surface[]', []) %}
        {% set vis_damage = form_data.get('vis_damage[]', []) %}
        {% set vis_package = form_data.get('vis_package[]', []) %}
        {% set vis_marking = form_data.get('vis_marking[]', []) %}
        {% set vis_result = form_data.get('vis_result[]', []) %}
    
        {% set vmax = [vis_batch|length, vis_flange|length, vis_surface|length, vis_damage|length, vis_package|length, vis_marking|length, vis_result|length] | max %}
        {% if vmax < 1 %}{% set vmax = 1 %}{% endif %}
    
        {% set cond_options = ["ACCEPTABLE", "OBSERVED (Minor issue)", "NOT ACCEPTABLE"] %}
    
        {% for i in range(vmax) %}
        <tr data-template="1">
          <td><input name="vis_batch[]" value="{{ vis_batch[i] if i < vis_batch|length else '' }}"></td>
          <td><input name="vis_flange[]" value="{{ vis_flange[i] if i < vis_flange|length else '' }}"></td>
    
          {% set cur_surface = (vis_surface[i] if i < vis_surface|length else '') %}
          <td>
            <select name="vis_surface[]">
              <option value="">-</option>
              {% for opt in cond_options %}
                <option value="{{ opt }}" {% if cur_surface == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </td>
    
          {% set cur_damage = (vis_damage[i] if i < vis_damage|length else '') %}
          <td>
            <select name="vis_damage[]">
              <option value="">-</option>
              {% for opt in cond_options %}
                <option value="{{ opt }}" {% if cur_damage == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </td>
    
          {% set cur_package = (vis_package[i] if i < vis_package|length else '') %}
          <td>
            <select name="vis_package[]">
              <option value="">-</option>
              {% for opt in cond_options %}
                <option value="{{ opt }}" {% if cur_package == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </td>
    
          {% set cur_marking = (vis_marking[i] if i < vis_marking|length else '') %}
          <td>
            <select name="vis_marking[]">
              <option value="">-</option>
              {% for opt in cond_options %}
                <option value="{{ opt }}" {% if cur_marking == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </td>
    
          <td>
            {% set cur = (vis_result[i] if i < vis_result|length else '') %}
            <select name="vis_result[]">
              <option value="" {% if cur == '' %}selected{% endif %}>-</option>
              <option value="ACC" {% if cur == 'ACC' %}selected{% endif %}>ACC</option>
              <option value="REJ" {% if cur == 'REJ' %}selected{% endif %}>REJ</option>
            </select>
          </td>
    
          <td><button type="button" class="btn btn-muted" onclick="removeRow(this)">X</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="button" class="btn btn-muted" onclick="addVisualRow()">+ Add Row</button>

    <!-- REMARKS -->
    <h3 class="mt">Remarks</h3>
    <textarea name="remarks" rows="4">{{ form_data.get('remarks','') or inspection.remarks or "" }}</textarea>

    <div class="mt">
      <button class="btn btn-primary" type="submit">Save / Submit</button>
      <a class="btn btn-muted" href="/mrr/{{ lot.id }}">Cancel</a>
    </div>
  </form>
</div>

  <!-- =========================
       Photo Evidence
  ========================== -->
  <div class="card inner mt">
    <div class="sectiontitle accent-blue">Photo Evidence</div>
    <div class="muted tiny">Add photos (packaging, labeling, damage, etc.). Anyone viewing this report will see them.</div>

    {% if photo_error %}
      <div class="alert alert-error mt">{{ photo_error }}</div>
    {% endif %}

    {% if not inspection.inspector_confirmed %}
      <form class="mt" action="/mrr/{{ lot.id }}/inspection/id/{{ inspection.id }}/photos/upload" method="post" enctype="multipart/form-data">
        <div class="grid3">
          <div>
            <label>Group / Category</label>
            <input name="group_name" placeholder="e.g., Packaging / Labeling / Damage" required>
            <div class="muted tiny">Use the same group name to keep photos together.</div>
          </div>
          <div>
            <label>Description (optional)</label>
            <input name="caption" placeholder="e.g., Outer wrap torn on one side">
          </div>
          <div>
            <label>Photos</label>
            <input type="file" name="photos" accept="image/*" capture="environment" multiple required>
            <div class="muted tiny">Capture from camera or upload (multiple allowed).</div>
          </div>
        </div>
        <div class="mt">
          <button class="btn btn-secondary" type="submit">Upload Photos</button>
        </div>
      </form>
    {% else %}
      <div class="muted tiny mt">Inspection is submitted â€” photos are locked (view only).</div>
    {% endif %}

    <style>
      .photo-thumb { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; border: 1px solid rgba(0,0,0,0.08); }
      .photo-card { padding: 8px; }
      .btn-small { padding: 6px 10px; font-size: 12px; }
    </style>

    {% if photo_groups and photo_groups|length > 0 %}
      <div class="mt">
        {% for gname, items in photo_groups.items() %}
          <div class="card inner mt">
            <div class="sectiontitle">{{ gname }}</div>
            <div class="grid3 mt">
              {% for p in items %}
                <div class="photo-card">
                  <a href="/mrr/photos/{{ p.id }}/view" target="_blank">
                    <img class="photo-thumb" src="/mrr/photos/{{ p.id }}/view" alt="photo">
                  </a>
                  {% if p.caption %}
                    <div class="muted tiny mt">{{ p.caption }}</div>
                  {% endif %}
                  {% if not inspection.inspector_confirmed %}
                    <form class="mt" action="/mrr/{{ lot.id }}/inspection/id/{{ inspection.id }}/photos/{{ p.id }}/delete" method="post">
                      <button class="btn btn-ghost btn-small" type="submit">Delete</button>
                    </form>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="muted tiny mt">No photos uploaded yet.</div>
    {% endif %}
  </div>
            
<script>
function addVisualRow() {
  const tbody = document.querySelector('#visualTable tbody');

  tbody.insertAdjacentHTML('beforeend', `
    <tr data-template="1">
      <td><input name="vis_batch[]"></td>
      <td><input name="vis_flange[]"></td>

      <td>
        <select name="vis_surface[]">
          <option value="">-</option>
          <option value="ACCEPTABLE">ACCEPTABLE</option>
          <option value="OBSERVED (Minor issue)">OBSERVED (Minor issue)</option>
          <option value="NOT ACCEPTABLE">NOT ACCEPTABLE</option>
        </select>
      </td>

      <td>
        <select name="vis_damage[]">
          <option value="">-</option>
          <option value="ACCEPTABLE">ACCEPTABLE</option>
          <option value="OBSERVED (Minor issue)">OBSERVED (Minor issue)</option>
          <option value="NOT ACCEPTABLE">NOT ACCEPTABLE</option>
        </select>
      </td>

      <td>
        <select name="vis_package[]">
          <option value="">-</option>
          <option value="ACCEPTABLE">ACCEPTABLE</option>
          <option value="OBSERVED (Minor issue)">OBSERVED (Minor issue)</option>
          <option value="NOT ACCEPTABLE">NOT ACCEPTABLE</option>
        </select>
      </td>

      <td>
        <select name="vis_marking[]">
          <option value="">-</option>
          <option value="ACCEPTABLE">ACCEPTABLE</option>
          <option value="OBSERVED (Minor issue)">OBSERVED (Minor issue)</option>
          <option value="NOT ACCEPTABLE">NOT ACCEPTABLE</option>
        </select>
      </td>

      <td>
        <select name="vis_result[]">
          <option value="">-</option>
          <option value="ACC">ACC</option>
          <option value="REJ">REJ</option>
        </select>
      </td>

      <td><button type="button" class="btn btn-muted" onclick="removeRow(this)">X</button></td>
    </tr>
  `);

  // Auto-fill new row heat number from first row if available
  const firstHeat = document.querySelector('#visualTable tbody tr input[name="vis_batch[]"]');
  const rows = document.querySelectorAll('#visualTable tbody tr');
  const last = rows[rows.length - 1];
  const heat = (firstHeat ? firstHeat.value : '').trim();
  if (heat && last) {
    const inp = last.querySelector('input[name="vis_batch[]"]');
    if (inp) inp.value = heat;
  }
}
</script>

{% endblock %}
